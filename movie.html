<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå½± - KatelyaTV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .header {
            background: white;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b9d;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: #ff6b9d;
            background: #fff0f5;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .theme-toggle,
        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover,
        .user-icon:hover {
            background: #f5f5f5;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-section {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #e0e0e0;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            flex: 1;
            height: 45px;
            padding: 0 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #ff6b9d;
        }

        .search-input::placeholder {
            color: #aaa;
        }

        .search-btn {
            height: 45px;
            padding: 0 25px;
            background: #ff6b9d;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            background: #e55a87;
            transform: translateY(-1px);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn.loading {
            background: #ccc;
            cursor: not-allowed;
        }

        .search-results-info {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            font-size: 16px;
        }

        .filter-section {
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .filter-label {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            min-width: 50px;
        }

        .filter-tags {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .filter-tag:hover,
        .filter-tag.active {
            background: #ff6b9d;
            color: white;
            border-color: #ff6b9d;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .movie-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .movie-poster {
            width: 100%;
            height: 280px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .movie-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .movie-info {
            padding: 15px;
        }

        .movie-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }

        .movie-meta {
            color: #666;
            font-size: 12px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
        }

        .movie-year {
            color: #999;
        }

        .movie-rating {
            background: #ff6b9d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .movie-type {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .movie-source {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .movie-tags {
            margin-left: auto;
            display: flex;
            gap: 4px;
        }

        .movie-source {
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .new-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .movie-poster {
            position: relative;
        }

        .loading-more {
            text-align: center;
            padding: 40px 0;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff6b9d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-more.hidden {
            display: none;
        }

        .loading-placeholder {
            grid-column: 1/-1;
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-placeholder .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .loading-placeholder .title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .loading-placeholder .subtitle {
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .nav-links {
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .nav-links a {
                font-size: 12px;
                padding: 6px 8px;
            }

            .container {
                padding: 20px 10px;
            }

            .filter-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .movies-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .movie-poster {
                height: 200px;
            }

            /* ç§»åŠ¨ç«¯æœç´¢æ¡†é€‚é… */
            .search-section {
                padding: 15px 10px;
            }

            .search-box {
                flex-direction: column;
                gap: 10px;
            }

            .search-input,
            .search-btn {
                width: 100%;
                max-width: none;
            }

            .search-btn {
                justify-content: center;
            }

            .search-results-info {
                font-size: 12px;
                padding: 0 5px;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <nav class="nav">
            <a href="#" class="logo">KatelyaTV</a>

            <div class="nav-links">
                <a href="movie.html">ğŸ  é¦–é¡µ</a>
                <a href="movie.html#movie" class="active">ğŸ¬ ç”µå½±</a>
                <a href="movie.html#tv">ğŸ“º å‰§é›†</a>
                <a href="movie.html#show">ğŸ“– ç»¼è‰º</a>
            </div>

            <div class="nav-right">
                <div class="theme-toggle" id="themeToggle">ğŸŒ™</div>
                <div class="user-icon">ğŸ‘¤</div>
            </div>
        </nav>
    </header>

    <div class="search-section">
        <div class="search-container">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ç”µå½±ã€å‰§é›†..." maxlength="50">
                <button class="search-btn" id="searchBtn">
                    <span>ğŸ”</span>
                    <span id="searchBtnText">æœç´¢</span>
                </button>
            </div>
        </div>
        <div class="search-results-info hidden" id="searchResultsInfo"></div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ç”µå½±</h1>
            <p class="page-subtitle">æ¥è‡ªè±†ç“£çš„ç²¾é€‰å†…å®¹</p>
        </div>

        <div class="filter-section" id="filterSection">
            <!-- ç­›é€‰å†…å®¹å°†æ ¹æ®å†…å®¹ç±»å‹åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="movies-grid" id="moviesGrid">
            <!-- ç”µå½±/å‰§é›†å¡ç‰‡å°†é€šè¿‡è°ƒç”¨è±†ç“£APIåŠ¨æ€åŠ è½½ -->
            <div class="loading-placeholder">
                <div class="icon">ğŸ“½ï¸</div>
                <div class="title">æ­£åœ¨åŠ è½½è±†ç“£å†…å®¹...</div>
                <div class="subtitle">è¯·ç¨å€™</div>
            </div>
        </div>

        <div class="loading-more hidden" id="loadingMore">
            <div class="loading-spinner"></div>
            <span>åŠ è½½æ›´å¤šç”µå½±...</span>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentMovies = []; // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„ç”µå½±åˆ—è¡¨
        let isSearchMode = false; // æ˜¯å¦å¤„äºæœç´¢æ¨¡å¼
        let currentKind = 'movie'; // å½“å‰å†…å®¹ç±»å‹ï¼šmovieã€tv æˆ– show

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        const themeToggle = document.getElementById('themeToggle');
        let isDarkMode = false;

        themeToggle.addEventListener('click', function() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.style.filter = 'invert(1) hue-rotate(180deg)';
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                document.body.style.filter = '';
                themeToggle.textContent = 'ğŸŒ™';
            }
        });

        // åˆå§‹åŒ–å¯¼èˆªæ ï¼ˆç°åœ¨ä½¿ç”¨hashå¯¼èˆªï¼Œä¸éœ€è¦JavaScriptäº‹ä»¶å¤„ç†ï¼‰
        function initNavigation() {
            // å¯¼èˆªæ ç°åœ¨ä½¿ç”¨hashé“¾æ¥ï¼Œè‡ªåŠ¨ç”±hashchangeäº‹ä»¶å¤„ç†
            console.log('å¯¼èˆªæ åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨hashå¯¼èˆª');
        }

        // åˆ‡æ¢å†…å®¹ç±»å‹ï¼ˆç”µå½±/å‰§é›†/ç»¼è‰ºï¼‰
        function switchContentType(newKind) {
            if (currentKind === newKind) {
                return; // å¦‚æœå·²ç»æ˜¯å½“å‰ç±»å‹ï¼Œä¸åšä»»ä½•æ“ä½œ
            }

            currentKind = newKind;
            isSearchMode = false; // é€€å‡ºæœç´¢æ¨¡å¼

            // æ›´æ–°URL hashï¼ˆä¸è§¦å‘hashchangeäº‹ä»¶ï¼‰
            if (window.location.hash !== `#${newKind}`) {
                history.pushState(null, null, `#${newKind}`);
            }

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const pageTitle = document.querySelector('.page-title');
            const pageSubtitle = document.querySelector('.page-subtitle');
            const searchInput = document.getElementById('searchInput');
            
            if (newKind === 'tv') {
                pageTitle.textContent = 'å‰§é›†';
                pageSubtitle.textContent = 'æ¥è‡ªè±†ç“£çš„ç²¾é€‰å‰§é›†';
                document.title = 'å‰§é›† - KatelyaTV';
                searchInput.placeholder = 'æœç´¢å‰§é›†...';
            } else if (newKind === 'show') {
                pageTitle.textContent = 'ç»¼è‰º';
                pageSubtitle.textContent = 'æ¥è‡ªè±†ç“£çš„ç²¾é€‰ç»¼è‰ºèŠ‚ç›®';
                document.title = 'ç»¼è‰º - KatelyaTV';
                searchInput.placeholder = 'æœç´¢ç»¼è‰ºèŠ‚ç›®...';
            } else {
                pageTitle.textContent = 'ç”µå½±';
                pageSubtitle.textContent = 'æ¥è‡ªè±†ç“£çš„ç²¾é€‰å†…å®¹';
                document.title = 'ç”µå½± - KatelyaTV';
                searchInput.placeholder = 'æœç´¢ç”µå½±ã€å‰§é›†...';
            }

            // æ›´æ–°å¯¼èˆªæ æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
                const linkHref = link.getAttribute('href');
                if ((newKind === 'movie' && linkHref === 'movie.html#movie') || 
                    (newKind === 'tv' && linkHref === 'movie.html#tv') ||
                    (newKind === 'show' && linkHref === 'movie.html#show')) {
                    link.classList.add('active');
                }
            });

            // æ›´æ–°ç­›é€‰åŒºåŸŸå†…å®¹
            updateFilterSection(newKind);

            // æ˜¾ç¤ºç­›é€‰åŒºåŸŸï¼ˆå¦‚æœä¹‹å‰è¢«éšè—ï¼‰
            document.querySelector('.filter-section').classList.remove('hidden');
            
            // éšè—æœç´¢ç»“æœä¿¡æ¯
            const searchResultsInfo = document.getElementById('searchResultsInfo');
            searchResultsInfo.classList.add('hidden');
            
            // ç§»é™¤æ¸…é™¤æœç´¢æŒ‰é’®
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.remove();
            }

            // æ›´æ–°"åŠ è½½æ›´å¤š"æ–‡æœ¬
            const loadingMoreText = document.querySelector('#loadingMore span');
            if (loadingMoreText) {
                const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
                const contentType = contentTypes[newKind] || 'å†…å®¹';
                loadingMoreText.textContent = `åŠ è½½æ›´å¤š${contentType}...`;
            }

            // é‡æ–°åŠ è½½æ•°æ®
            loadMovies('çƒ­é—¨ç”µå½±');

            const modeNames = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
            console.log(`å·²åˆ‡æ¢åˆ°${modeNames[newKind] || newKind}æ¨¡å¼`);
        }

        // æ›´æ–°ç­›é€‰åŒºåŸŸå†…å®¹
        function updateFilterSection(kind) {
            const filterSection = document.getElementById('filterSection');
            
            if (kind === 'movie') {
                // ç”µå½±æ¨¡å¼ï¼šåˆ†ç±» + åœ°åŒºç­›é€‰
                filterSection.innerHTML = `
                    <div class="filter-row">
                        <span class="filter-label">åˆ†ç±»</span>
                        <div class="filter-tags">
                            <a href="#" class="filter-tag active" data-category="çƒ­é—¨">çƒ­é—¨</a>
                            <a href="#" class="filter-tag" data-category="æœ€æ–°">æœ€æ–°</a>
                            <a href="#" class="filter-tag" data-category="è±†ç“£é«˜åˆ†">è±†ç“£é«˜åˆ†</a>
                            <a href="#" class="filter-tag" data-category="å†·é—¨ä½³ç‰‡">å†·é—¨ä½³ç‰‡</a>
                        </div>
                    </div>
                    <div class="filter-row">
                        <span class="filter-label">åœ°åŒº</span>
                        <div class="filter-tags">
                            <a href="#" class="filter-tag active" data-type="">å…¨éƒ¨</a>
                            <a href="#" class="filter-tag" data-type="åè¯­">åè¯­</a>
                            <a href="#" class="filter-tag" data-type="æ¬§ç¾">æ¬§ç¾</a>
                            <a href="#" class="filter-tag" data-type="éŸ©å›½">éŸ©å›½</a>
                            <a href="#" class="filter-tag" data-type="æ—¥æœ¬">æ—¥æœ¬</a>
                        </div>
                    </div>
                `;
            } else if (kind === 'tv') {
                // å‰§é›†æ¨¡å¼ï¼šå•è¡Œç±»å‹ç­›é€‰
                filterSection.innerHTML = `
                    <div class="filter-row">
                        <span class="filter-label">ç±»å‹</span>
                        <div class="filter-tags">
                            <a href="#" class="filter-tag active" data-type="tv">ç»¼åˆ</a>
                            <a href="#" class="filter-tag" data-type="tv_domestic">å›½äº§å‰§</a>
                            <a href="#" class="filter-tag" data-type="tv_american">æ¬§ç¾å‰§</a>
                            <a href="#" class="filter-tag" data-type="tv_japanese">æ—¥å‰§</a>
                            <a href="#" class="filter-tag" data-type="tv_korean">éŸ©å‰§</a>
                            <a href="#" class="filter-tag" data-type="tv_animation">åŠ¨ç”»</a>
                            <a href="#" class="filter-tag" data-type="tv_documentary">çºªå½•ç‰‡</a>
                        </div>
                    </div>
                `;
            } else if (kind === 'show') {
                // ç»¼è‰ºæ¨¡å¼ï¼šå•è¡Œç±»å‹ç­›é€‰
                filterSection.innerHTML = `
                    <div class="filter-row">
                        <span class="filter-label">ç±»å‹</span>
                        <div class="filter-tags">
                            <a href="#" class="filter-tag active" data-type="show">ç»¼åˆ</a>
                            <a href="#" class="filter-tag" data-type="show_domestic">å›½å†…</a>
                            <a href="#" class="filter-tag" data-type="show_foreign">å›½å¤–</a>
                        </div>
                    </div>
                `;
            }
            
            // é‡æ–°ç»‘å®šç­›é€‰æ ‡ç­¾äº‹ä»¶
            bindFilterTagEvents();
        }

        // ç»‘å®šç­›é€‰æ ‡ç­¾äº‹ä»¶
        function bindFilterTagEvents() {
            document.querySelectorAll('.filter-tag').forEach(tag => {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œæ·»åŠ æ–°çš„
                tag.replaceWith(tag.cloneNode(true));
            });
            
            // é‡æ–°æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', handleFilterTagClick);
            });
        }

        // ç­›é€‰æ ‡ç­¾ç‚¹å‡»å¤„ç†å‡½æ•°
        function handleFilterTagClick(e) {
            e.preventDefault();
            
            // å¦‚æœå¤„äºæœç´¢æ¨¡å¼ï¼Œä¸æ‰§è¡Œç­›é€‰
            if (isSearchMode) {
                return;
            }
            
            // ç§»é™¤åŒä¸€è¡Œå…¶ä»–æ ‡ç­¾çš„ active çŠ¶æ€
            const parentRow = this.closest('.filter-row');
            parentRow.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
            
            // æ¿€æ´»å½“å‰æ ‡ç­¾
            this.classList.add('active');

            // æ ¹æ®å†…å®¹ç±»å‹å’Œæ ‡ç­¾ç±»å‹æ‰§è¡Œç­›é€‰
            if (currentKind === 'movie') {
                // ç”µå½±æ¨¡å¼ï¼šæ ¹æ®åˆ†ç±»è¡Œçš„æ´»è·ƒæ ‡ç­¾è·å–ç­›é€‰æ¡ä»¶
                const activeCategoryTag = document.querySelector('.filter-row:nth-child(1) .filter-tag.active');
                const filter = activeCategoryTag?.textContent || 'çƒ­é—¨';
                const categoryMap = {
                    'çƒ­é—¨': 'çƒ­é—¨ç”µå½±',
                    'æœ€æ–°': 'æœ€æ–°ç”µå½±',
                    'è±†ç“£é«˜åˆ†': 'è±†ç“£é«˜åˆ†',
                    'å†·é—¨ä½³ç‰‡': 'å†·é—¨ä½³ç‰‡'
                };
                console.log('ç”µå½±ç­›é€‰ - åˆ†ç±»:', filter, 'åœ°åŒº:', this.getAttribute('data-type') || 'å…¨éƒ¨');
                loadMovies(categoryMap[filter] || 'çƒ­é—¨ç”µå½±');
            } else {
                // å‰§é›†/ç»¼è‰ºæ¨¡å¼ï¼šç±»å‹ç­›é€‰
                const typeText = this.textContent;
                const typeValue = this.getAttribute('data-type');
                console.log(`${currentKind === 'tv' ? 'å‰§é›†' : 'ç»¼è‰º'}ç­›é€‰ - ç±»å‹:`, typeText, 'å€¼:', typeValue);
                loadMovies('çƒ­é—¨ç”µå½±'); // ä½¿ç”¨é»˜è®¤åˆ†ç±»å‚æ•°
            }
        }


        // æœç´¢åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchBtnText = document.getElementById('searchBtnText');
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const moviesGrid = document.getElementById('moviesGrid');

        // æœç´¢APIè°ƒç”¨
        async function searchMovies(query) {
            try {
                const response = await fetch(`/movie/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.results || [];
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                throw error;
            }
        }

        // æ¸²æŸ“ç”µå½±å¡ç‰‡
        function renderMovieCard(movie) {
            return `
                <div class="movie-card" data-id="${movie.id || ''}" data-source="${movie.source || ''}">
                    <div class="movie-poster">
                        ${movie.poster ? 
                            `<img src="${movie.poster}" alt="${movie.title}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span>æµ·æŠ¥åŠ è½½å¤±è´¥</span>'">` :
                            '<span>æš‚æ— æµ·æŠ¥</span>'
                        }
                    </div>
                    <div class="movie-info">
                        <div class="movie-title">${movie.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
                        <div class="movie-meta">
                            <span class="movie-year">${movie.year || 'æœªçŸ¥å¹´ä»½'}</span>
                            <div class="movie-tags">
                                ${movie.type_name ? `<span class="movie-type">${movie.type_name}</span>` : ''}
                                ${movie.douban_id && movie.douban_id > 0 ? `<span class="movie-rating">è±†ç“£</span>` : ''}
                                ${movie.source_name ? `<span class="movie-source" title="æ•°æ®æ¥æº">${movie.source_name}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ›´æ–°ç”µå½±ç½‘æ ¼
        function updateMoviesGrid(movies) {
            if (movies.length === 0) {
                moviesGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç”µå½±</div>
                        <div style="font-size: 14px;">è¯·å°è¯•å…¶ä»–å…³é”®è¯</div>
                    </div>
                `;
                return;
            }

            moviesGrid.innerHTML = movies.map(movie => renderMovieCard(movie)).join('');
        }

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            // è®¾ç½®æœç´¢çŠ¶æ€
            searchBtn.classList.add('loading');
            searchBtnText.textContent = 'æœç´¢ä¸­...';
            searchBtn.disabled = true;
            
            // æ˜¾ç¤ºæœç´¢ä¿¡æ¯
            searchResultsInfo.classList.remove('hidden');
            searchResultsInfo.textContent = `æ­£åœ¨æœç´¢ "${query}"...`;

            try {
                const results = await searchMovies(query);
                currentMovies = results;
                isSearchMode = true;

                // ç»Ÿè®¡ä¸åŒæ¥æºçš„ç»“æœæ•°é‡
                const sourceStats = {};
                results.forEach(movie => {
                    const sourceName = movie.source_name || 'æœªçŸ¥æ¥æº';
                    sourceStats[sourceName] = (sourceStats[sourceName] || 0) + 1;
                });
                
                // æ„å»ºæ¥æºç»Ÿè®¡ä¿¡æ¯
                const sourceStatsText = Object.entries(sourceStats)
                    .sort((a, b) => b[1] - a[1]) // æŒ‰æ•°é‡å€’åºæ’åˆ—
                    .map(([source, count]) => `${source}: ${count}`)
                    .join(' | ');
                
                // æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
                searchResultsInfo.innerHTML = `
                    <div>æ‰¾åˆ° ${results.length} ä¸ªç›¸å…³ç»“æœ</div>
                    <div style="font-size: 12px; color: #888; margin-top: 5px;">æ•°æ®æºåˆ†å¸ƒ: ${sourceStatsText}</div>
                `;
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.querySelector('.page-title').textContent = `æœç´¢ç»“æœ`;
                document.querySelector('.page-subtitle').textContent = `å…³é”®è¯: "${query}"`;
                
                // éšè—ç­›é€‰åŒºåŸŸ
                document.querySelector('.filter-section').classList.add('hidden');
                
                // æ›´æ–°ç”µå½±ç½‘æ ¼
                updateMoviesGrid(results);

                // æ·»åŠ æ¸…é™¤æœç´¢æŒ‰é’®
                if (!document.getElementById('clearSearchBtn')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.id = 'clearSearchBtn';
                    clearBtn.textContent = 'Ã— æ¸…é™¤æœç´¢';
                    clearBtn.style.cssText = `
                        margin-left: 10px; 
                        padding: 8px 15px; 
                        background: #f5f5f5; 
                        border: 1px solid #ddd; 
                        border-radius: 20px; 
                        font-size: 12px; 
                        cursor: pointer;
                        color: #666;
                    `;
                    clearBtn.addEventListener('click', clearSearch);
                    searchResultsInfo.appendChild(clearBtn);
                }

            } catch (error) {
                searchResultsInfo.textContent = 'æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                console.error('æœç´¢é”™è¯¯:', error);
            } finally {
                // æ¢å¤æœç´¢æŒ‰é’®çŠ¶æ€
                searchBtn.classList.remove('loading');
                searchBtnText.textContent = 'æœç´¢';
                searchBtn.disabled = false;
            }
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            isSearchMode = false;
            searchInput.value = '';
            
            // æ¢å¤é¡µé¢æ ‡é¢˜
            document.querySelector('.page-title').textContent = 'ç”µå½±';
            document.querySelector('.page-subtitle').textContent = 'æ¥è‡ªè±†ç“£çš„ç²¾é€‰å†…å®¹';
            
            // æ˜¾ç¤ºç­›é€‰åŒºåŸŸ
            document.querySelector('.filter-section').classList.remove('hidden');
            
            // éšè—æœç´¢ç»“æœä¿¡æ¯
            searchResultsInfo.classList.add('hidden');
            
            // æ¢å¤é»˜è®¤ç”µå½±ç½‘æ ¼
            restoreDefaultMovies();
            
            // ç§»é™¤æ¸…é™¤æœç´¢æŒ‰é’®
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.remove();
            }
        }

        // æ¢å¤é»˜è®¤ç”µå½±æ˜¾ç¤º
        function restoreDefaultMovies() {
            // é‡æ–°åŠ è½½è±†ç“£çƒ­é—¨ç”µå½±
            loadMovies('çƒ­é—¨ç”µå½±');
        }

        // æœç´¢äº‹ä»¶ç›‘å¬å™¨
        searchBtn.addEventListener('click', performSearch);
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // ç”µå½±å¡ç‰‡ç‚¹å‡»åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.closest('.movie-card')) {
                const card = e.target.closest('.movie-card');
                const movieId = card.getAttribute('data-id');
                const source = card.getAttribute('data-source');
                const doubanId = card.getAttribute('data-douban-id');
                const title = card.querySelector('.movie-title').textContent;
                
                // å¦‚æœæ˜¯æœç´¢ç»“æœä¸”æœ‰æ’­æ”¾é“¾æ¥ï¼Œè·³è½¬æ’­æ”¾é¡µé¢
                if (isSearchMode && currentMovies.length > 0) {
                    const movieData = currentMovies.find(movie => 
                        movie.id === movieId && movie.source === source
                    );
                    
                    if (movieData && movieData.episodes && movieData.episodes.length > 0) {
                        // å¦‚æœæœ‰é›†æ•°ä¿¡æ¯ï¼Œè·³è½¬åˆ°æ’­æ”¾é¡µé¢
                        window.location.href = `player.html?id=${movieId}&source=${source}&index=0&title=${encodeURIComponent(title)}`;
                    } else if (movieData && movieData.source !== 'douban') {
                        // å…¶ä»–æºä½†æ²¡æœ‰é›†æ•°ä¿¡æ¯ï¼Œä½¿ç”¨è¯¦æƒ…é¡µé¢
                        window.location.href = `player.html?id=${movieId}&source=${source}&index=0`;
                    } else {
                        // è±†ç“£æ•°æ®ï¼Œåœ¨æ–°çª—å£æ‰“å¼€è±†ç“£é¡µé¢å¹¶æœç´¢æ’­æ”¾æº
                        handleDoubanMovieClick(title, doubanId);
                    }
                } else if (source === 'douban') {
                    // è±†ç“£ç”µå½±å¡ç‰‡ç‚¹å‡»å¤„ç†
                    handleDoubanMovieClick(title, doubanId);
                } else if (movieId && source) {
                    // æœ‰æ’­æ”¾æºçš„ç”µå½±ï¼Œè·³è½¬åˆ°æ’­æ”¾é¡µé¢
                    window.location.href = `player.html?id=${movieId}&source=${source}&index=0`;
                } else {
                    // ä½¿ç”¨æ ‡é¢˜æœç´¢
                    window.location.href = `player.html?title=${encodeURIComponent(title)}`;
                }
            }
        });

        // å¤„ç†è±†ç“£ç”µå½±ç‚¹å‡»
        function handleDoubanMovieClick(title, doubanId) {
            // æ˜¾ç¤ºæ“ä½œé€‰æ‹©å¯¹è¯æ¡†
            const actions = [
                { text: 'åœ¨è±†ç“£æŸ¥çœ‹è¯¦æƒ…', action: () => {
                    window.open(`https://movie.douban.com/subject/${doubanId}/`, '_blank');
                }},
                { text: 'æœç´¢æ’­æ”¾æº', action: async () => {
                    // åœ¨å½“å‰é¡µé¢æœç´¢è¿™éƒ¨ç”µå½±
                    document.getElementById('searchInput').value = title;
                    await performSearch();
                    // æœç´¢å®Œæˆåè‡ªåŠ¨å…³é—­å¼¹å‡ºæ¡†
                    const dialog = document.getElementById('movieActionDialog');
                    if (dialog) {
                        dialog.remove();
                    }
                }},
                { text: 'å–æ¶ˆ', action: () => {
                    // å…³é—­å¯¹è¯æ¡†
                    document.getElementById('movieActionDialog').remove();
                }}
            ];

            showMovieActionDialog(title, actions);
        }

        // æ˜¾ç¤ºç”µå½±æ“ä½œå¯¹è¯æ¡†
        function showMovieActionDialog(title, actions) {
            // å¦‚æœå·²ç»æœ‰å¯¹è¯æ¡†ï¼Œå…ˆç§»é™¤
            const existingDialog = document.getElementById('movieActionDialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.id = 'movieActionDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            const dialogContent = document.createElement('div');
            dialogContent.style.cssText = `
                background: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                width: 90%;
                text-align: center;
            `;

            dialogContent.innerHTML = `
                <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">${title}</h3>
                <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">é€‰æ‹©ä½ æƒ³è¦çš„æ“ä½œï¼š</p>
                <div id="dialogActions"></div>
            `;

            const actionsContainer = dialogContent.querySelector('#dialogActions');
            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.text;
                button.style.cssText = `
                    display: block;
                    width: 100%;
                    margin: 8px 0;
                    padding: 12px;
                    background: ${action.text === 'å–æ¶ˆ' ? '#f5f5f5' : '#ff6b9d'};
                    color: ${action.text === 'å–æ¶ˆ' ? '#666' : 'white'};
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s;
                `;
                button.addEventListener('click', action.action);
                actionsContainer.appendChild(button);
            });

            dialog.appendChild(dialogContent);
            document.body.appendChild(dialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    dialog.remove();
                }
            });
        }

        // è°ƒç”¨è±†ç“£APIè·å–ç”µå½±/å‰§é›†æ•°æ®
        async function fetchDoubanMovies(category = 'æœ€æ–°', type = 'åè¯­', start = 0, limit = 25, kind = null) {
            try {
                const params = new URLSearchParams({
                    kind: kind || currentKind,
                    start: start.toString(),
                    limit: limit.toString(),
                    category,
                    type,
                    useProxy: 'true'
                });
                
                const response = await fetch(`/movie/douban?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('è·å–è±†ç“£ç”µå½±æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // å°†è±†ç“£æ•°æ®è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
        function transformDoubanData(doubanData) {
            if (!doubanData || !doubanData.items) {
                return [];
            }
            
            return doubanData.items.map(movie => {
                // è§£æcard_subtitleè·å–å¹´ä»½ã€åœ°åŒºã€ç±»å‹ä¿¡æ¯
                const subtitle = movie.card_subtitle || '';
                const subtitleParts = subtitle.split(' / ');
                const year = subtitleParts[0] || 'æœªçŸ¥å¹´ä»½';
                const region = subtitleParts[1] || '';
                const genres = subtitleParts.slice(2, -1).join(' / ') || ''; // æ’é™¤æœ€åçš„å¯¼æ¼”/æ¼”å‘˜ä¿¡æ¯
                
                return {
                    id: movie.id?.toString() || '',
                    title: movie.title || 'æœªçŸ¥æ ‡é¢˜',
                    poster: movie.pic?.large || movie.pic?.normal || '',
                    year: year,
                    type_name: genres,
                    region: region,
                    douban_id: movie.id || 0,
                    rating: movie.rating?.value || null,
                    rating_count: movie.rating?.count || 0,
                    star_count: movie.rating?.star_count || 0,
                    is_new: movie.is_new || false,
                    card_subtitle: movie.card_subtitle || '',
                    source: 'douban',
                    episodes: [] // è±†ç“£æ•°æ®ä¸åŒ…å«æ’­æ”¾é“¾æ¥
                };
            });
        }

        // æ¸²æŸ“è±†ç“£ç”µå½±å¡ç‰‡
        function renderDoubanMovieCard(movie) {
            // æ ¼å¼åŒ–è¯„åˆ†æ˜¾ç¤º
            let ratingDisplay = '';
            if (movie.rating) {
                const rating = parseFloat(movie.rating).toFixed(1);
                const count = movie.rating_count || 0;
                ratingDisplay = `${rating}${count > 0 ? ` (${count > 10000 ? Math.floor(count/1000) + 'k' : count})` : ''}`;
            }

            return `
                <div class="movie-card" data-id="${movie.id}" data-source="${movie.source}" data-douban-id="${movie.douban_id}">
                    <div class="movie-poster">
                        ${movie.poster ? 
                            `<img src="${movie.poster}" loading="lazy" referrerpolicy="no-referrer" alt="${movie.title}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span>æµ·æŠ¥åŠ è½½å¤±è´¥</span>'">${movie.is_new ? '<div class="new-badge">æ–°</div>' : ''}` :
                            '<span>æš‚æ— æµ·æŠ¥</span>'
                        }
                    </div>
                    <div class="movie-info">
                        <div class="movie-title">${movie.title}</div>
                        <div class="movie-meta">
                            <span class="movie-year">${movie.year}${movie.region ? ' / ' + movie.region : ''}</span>
                            <div class="movie-tags">
                                ${movie.type_name ? `<span class="movie-type">${movie.type_name}</span>` : ''}
                                ${ratingDisplay ? `<span class="movie-rating">${ratingDisplay}</span>` : ''}
                                <span class="movie-source">è±†ç“£</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // åŠ è½½ç”µå½±æ•°æ®ï¼ˆæ ¹æ®ç­›é€‰æ¡ä»¶ï¼‰
        async function loadMovies(filter = 'çƒ­é—¨ç”µå½±') {
            if (isSearchMode) {
                return; // æœç´¢æ¨¡å¼ä¸‹ä¸é‡æ–°åŠ è½½
            }

            // é‡ç½®åˆ†é¡µ
            resetPagination();

            const loadingMore = document.getElementById('loadingMore');
            loadingMore.classList.remove('hidden');

            try {
                let category, type, apiKind;
                
                if (currentKind === 'tv') {
                    // å‰§é›†æ¨¡å¼ï¼šcategoryå›ºå®šä¸º"tv"ï¼Œtypeæ ¹æ®ç±»å‹ç­›é€‰
                    category = 'tv';
                    apiKind = 'tv';
                    
                    // è·å–å½“å‰æ¿€æ´»çš„ç±»å‹ç­›é€‰
                    const activeTypeTag = document.querySelector('.filter-row .filter-tag.active');
                    if (activeTypeTag) {
                        type = activeTypeTag.getAttribute('data-type') || 'tv';
                    } else {
                        type = 'tv';
                    }
                } else if (currentKind === 'show') {
                    // ç»¼è‰ºæ¨¡å¼ï¼škindå›ºå®šä¸º"tv"ï¼Œcategoryå›ºå®šä¸º"show"
                    category = 'show';
                    apiKind = 'tv';
                    
                    // è·å–å½“å‰æ¿€æ´»çš„ç±»å‹ç­›é€‰
                    const activeTypeTag = document.querySelector('.filter-row .filter-tag.active');
                    if (activeTypeTag) {
                        type = activeTypeTag.getAttribute('data-type') || 'show';
                    } else {
                        type = 'show';
                    }
                } else {
                    // ç”µå½±æ¨¡å¼ï¼šåˆ†ç±» + åœ°åŒºç­›é€‰
                    category = 'æœ€æ–°';
                    type = 'åè¯­';
                    apiKind = 'movie';
                    
                    switch(filter) {
                        case 'çƒ­é—¨ç”µå½±':
                            category = 'çƒ­é—¨';
                            break;
                        case 'æœ€æ–°ç”µå½±':
                            category = 'æœ€æ–°';
                            break;
                        case 'è±†ç“£é«˜åˆ†':
                            category = 'è±†ç“£é«˜åˆ†';
                            break;
                        case 'å†·é—¨ä½³ç‰‡':
                            category = 'å†·é—¨ä½³ç‰‡';
                            break;
                    }

                    // è·å–å½“å‰æ¿€æ´»çš„åœ°åŒºç­›é€‰
                    const activeRegionTag = document.querySelector('.filter-row:nth-child(2) .filter-tag.active');
                    if (activeRegionTag) {
                        const regionData = activeRegionTag.getAttribute('data-type');
                        if (regionData !== null) {
                            type = regionData;
                        }
                    }
                }

                const doubanData = await fetchDoubanMovies(category, type, 0, 25, apiKind);
                const movies = transformDoubanData(doubanData);
                
                currentMovies = movies;
                updateDoubanMoviesGrid(movies);
                
                    const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
                    const contentType = contentTypes[currentKind] || 'å†…å®¹';
                    console.log(`å·²åŠ è½½ ${filter} åˆ†ç±»çš„${contentType}ï¼Œå…± ${movies.length} éƒ¨`);
                    
                    // æ›´æ–°"åŠ è½½æ›´å¤š"æ–‡æœ¬
                    const loadingMoreText = document.querySelector('#loadingMore span');
                    if (loadingMoreText) {
                        loadingMoreText.textContent = `åŠ è½½æ›´å¤š${contentType}...`;
                    }
                
            } catch (error) {
                const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
                const contentType = contentTypes[currentKind] || 'å†…å®¹';
                console.error(`åŠ è½½${contentType}æ•°æ®å¤±è´¥:`, error);
                showMovieLoadError();
            } finally {
                loadingMore.classList.add('hidden');
            }
        }

        // æ›´æ–°è±†ç“£ç”µå½±/å‰§é›†/ç»¼è‰ºç½‘æ ¼
        function updateDoubanMoviesGrid(movies) {
            const moviesGrid = document.getElementById('moviesGrid');
            const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
            const icons = { 'movie': 'ğŸ¬', 'tv': 'ğŸ“º', 'show': 'ğŸ­' };
            const contentType = contentTypes[currentKind] || 'å†…å®¹';
            const icon = icons[currentKind] || 'ğŸ“½ï¸';
            
            if (movies.length === 0) {
                moviesGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">${icon}</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">æš‚æ— ${contentType}æ•°æ®</div>
                        <div style="font-size: 14px;">è¯·å°è¯•å…¶ä»–åˆ†ç±»æˆ–ç¨åé‡è¯•</div>
                    </div>
                `;
                return;
            }

            moviesGrid.innerHTML = movies.map(movie => renderDoubanMovieCard(movie)).join('');
        }

        // æ˜¾ç¤ºåŠ è½½é”™è¯¯
        function showMovieLoadError() {
            const moviesGrid = document.getElementById('moviesGrid');
            const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
            const contentType = contentTypes[currentKind] || 'å†…å®¹';
            moviesGrid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">${contentType}åŠ è½½å¤±è´¥</div>
                    <div style="font-size: 14px;">ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•</div>
                    <button onclick="loadMovies('çƒ­é—¨ç”µå½±')" style="margin-top: 15px; padding: 8px 20px; background: #ff6b9d; color: white; border: none; border-radius: 20px; cursor: pointer;">é‡æ–°åŠ è½½</button>
                </div>
            `;
        }

        // é¡µé¢æ»šåŠ¨åˆ°åº•éƒ¨æ—¶åŠ è½½æ›´å¤š
        let isLoading = false;
        window.addEventListener('scroll', function() {
            if (isLoading) return;
            
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            
            if (scrollTop + clientHeight >= scrollHeight - 5) {
                isLoading = true;
                loadMoreMovies().then(() => {
                    isLoading = false;
                });
            }
        });

        let currentPage = 0; // å½“å‰é¡µç 
        const pageSize = 25; // æ¯é¡µæ•°é‡

        async function loadMoreMovies() {
            // å¦‚æœå¤„äºæœç´¢æ¨¡å¼ï¼Œä¸åŠ è½½æ›´å¤š
            if (isSearchMode) {
                console.log('æœç´¢æ¨¡å¼ä¸‹ä¸æ”¯æŒåŠ è½½æ›´å¤š');
                return;
            }

            const loadingMore = document.getElementById('loadingMore');
            loadingMore.classList.remove('hidden');
            
            try {
                currentPage++; // å¢åŠ é¡µç 
                const start = currentPage * pageSize;
                
                let category, type, apiKind;
                
                if (currentKind === 'tv') {
                    // å‰§é›†æ¨¡å¼ï¼šcategoryå›ºå®šä¸º"tv"ï¼Œtypeæ ¹æ®ç±»å‹ç­›é€‰
                    category = 'tv';
                    apiKind = 'tv';
                    
                    // è·å–å½“å‰æ¿€æ´»çš„ç±»å‹ç­›é€‰
                    const activeTypeTag = document.querySelector('.filter-row .filter-tag.active');
                    if (activeTypeTag) {
                        type = activeTypeTag.getAttribute('data-type') || 'tv';
                    } else {
                        type = 'tv';
                    }
                } else if (currentKind === 'show') {
                    // ç»¼è‰ºæ¨¡å¼ï¼škindå›ºå®šä¸º"tv"ï¼Œcategoryå›ºå®šä¸º"show"
                    category = 'show';
                    apiKind = 'tv';
                    
                    // è·å–å½“å‰æ¿€æ´»çš„ç±»å‹ç­›é€‰
                    const activeTypeTag = document.querySelector('.filter-row .filter-tag.active');
                    if (activeTypeTag) {
                        type = activeTypeTag.getAttribute('data-type') || 'show';
                    } else {
                        type = 'show';
                    }
                } else {
                    // ç”µå½±æ¨¡å¼ï¼šåˆ†ç±» + åœ°åŒºç­›é€‰
                    const activeCategoryTag = document.querySelector('.filter-row:nth-child(1) .filter-tag.active');
                    const activeRegionTag = document.querySelector('.filter-row:nth-child(2) .filter-tag.active');
                    
                    category = 'çƒ­é—¨';
                    type = 'åè¯­';
                    apiKind = 'movie';
                    
                    if (activeCategoryTag) {
                        const categoryText = activeCategoryTag.textContent;
                        switch(categoryText) {
                            case 'çƒ­é—¨':
                                category = 'çƒ­é—¨';
                                break;
                            case 'æœ€æ–°':
                                category = 'æœ€æ–°';
                                break;
                            case 'è±†ç“£é«˜åˆ†':
                                category = 'è±†ç“£é«˜åˆ†';
                                break;
                            case 'å†·é—¨ä½³ç‰‡':
                                category = 'å†·é—¨ä½³ç‰‡';
                                break;
                        }
                    }
                    
                    if (activeRegionTag) {
                        const regionData = activeRegionTag.getAttribute('data-type');
                        if (regionData !== null) {
                            type = regionData;
                        }
                    }
                }

                const doubanData = await fetchDoubanMovies(category, type, start, pageSize, apiKind);
                const newMovies = transformDoubanData(doubanData);
                console.log(newMovies);
                
                if (newMovies.length > 0) {
                    // å°†æ–°ç”µå½±æ·»åŠ åˆ°ç°æœ‰åˆ—è¡¨
                    currentMovies = [...currentMovies, ...newMovies];
                    
                    // å°†æ–°ç”µå½±å¡ç‰‡æ·»åŠ åˆ°ç°æœ‰ç½‘æ ¼
                    const moviesGrid = document.getElementById('moviesGrid');
                    const newMoviesHTML = newMovies.map(movie => renderDoubanMovieCard(movie)).join('');
                    moviesGrid.insertAdjacentHTML('beforeend', newMoviesHTML);
                    
                    const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
                    const contentType = contentTypes[currentKind] || 'å†…å®¹';
                    console.log(`å·²åŠ è½½æ›´å¤š${contentType}ï¼Œæ–°å¢ ${newMovies.length} éƒ¨`);
                } else {
                    const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
                    const contentType = contentTypes[currentKind] || 'å†…å®¹';
                    console.log(`æ²¡æœ‰æ›´å¤š${contentType}äº†`);
                    currentPage--; // å›é€€é¡µç 
                }
                
            } catch (error) {
                const contentTypes = { 'movie': 'ç”µå½±', 'tv': 'å‰§é›†', 'show': 'ç»¼è‰º' };
                const contentType = contentTypes[currentKind] || 'å†…å®¹';
                console.error(`åŠ è½½æ›´å¤š${contentType}å¤±è´¥:`, error);
                currentPage--; // å›é€€é¡µç 
            } finally {
                loadingMore.classList.add('hidden');
            }
        }

        // é‡ç½®é¡µç ï¼ˆåœ¨åˆ‡æ¢ç­›é€‰æ¡ä»¶æ—¶è°ƒç”¨ï¼‰
        function resetPagination() {
            currentPage = 0;
        }

        // æ£€æŸ¥URL hashå¹¶åˆ‡æ¢åˆ°å¯¹åº”æ¨¡å¼
        function checkUrlHashAndSwitch() {
            const hash = window.location.hash.replace('#', '');
            console.log('æ£€æµ‹åˆ°URL hash:', hash);
            
            if (hash === 'movie' || hash === 'tv' || hash === 'show') {
                console.log('æ ¹æ®hashåˆ‡æ¢åˆ°æ¨¡å¼:', hash);
                switchContentType(hash);
                return hash;
            }
            return 'movie'; // é»˜è®¤è¿”å›ç”µå½±æ¨¡å¼
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å†…å®¹é¡µé¢å·²åŠ è½½');
            
            // åˆå§‹åŒ–å¯¼èˆªæ 
            initNavigation();
            
            // æ£€æŸ¥URL hashå¹¶åˆ‡æ¢æ¨¡å¼ï¼Œå¦‚æœæ²¡æœ‰hashåˆ™é»˜è®¤ç”µå½±æ¨¡å¼
            const initialMode = checkUrlHashAndSwitch();
            
            // å¦‚æœæ²¡æœ‰é€šè¿‡hashåˆ‡æ¢æ¨¡å¼ï¼Œåˆ™åˆå§‹åŒ–é»˜è®¤æ¨¡å¼
            if (initialMode === 'movie' && !window.location.hash) {
                updateFilterSection('movie');
                loadMovies('çƒ­é—¨ç”µå½±');
            }
        });

        // ç›‘å¬hashå˜åŒ–ï¼ˆç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‰è¿›åé€€æŒ‰é’®æ—¶ï¼‰
        window.addEventListener('hashchange', function() {
            console.log('hashå‘ç”Ÿå˜åŒ–:', window.location.hash);
            checkUrlHashAndSwitch();
        });
    </script>
</body>

</html>
