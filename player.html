<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æ’­æ”¾ - KatelyaTV</title>
    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="./libs/hls.min.js"></script>
    <script src="./libs/artplayer.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .header {
            background: white;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b9d;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #ff6b9d;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .theme-toggle,
        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover,
        .user-icon:hover {
            background: #f5f5f5;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-section {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #e0e0e0;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            flex: 1;
            height: 45px;
            padding: 0 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #ff6b9d;
        }

        .search-input::placeholder {
            color: #aaa;
        }

        .search-btn {
            height: 45px;
            padding: 0 25px;
            background: #ff6b9d;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            background: #e55a87;
            transform: translateY(-1px);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn.loading {
            background: #ccc;
            cursor: not-allowed;
        }

        .search-results-info {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-size: 14px;
        }

        .search-results-info.hidden {
            display: none;
        }

        /* ç½‘å€è¾“å…¥æ¡†æ ·å¼ */
        .url-section {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .url-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .url-box {
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        .url-input {
            flex: 1;
            height: 40px;
            padding: 0 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            background: white;
        }

        .url-input:focus {
            border-color: #ff6b9d;
            box-shadow: 0 0 0 2px rgba(255, 107, 157, 0.1);
        }

        .url-input::placeholder {
            color: #999;
            font-size: 13px;
        }

        .url-btn {
            height: 40px;
            padding: 0 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            justify-content: center;
        }

        .url-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .url-btn:active {
            transform: translateY(0);
        }

        .url-btn.loading {
            background: #6c757d;
            cursor: not-allowed;
        }

        .url-tips {
            text-align: center;
            margin-top: 8px;
        }

        .tip-text {
            font-size: 12px;
            color: #6c757d;
            background: white;
            padding: 4px 12px;
            border-radius: 12px;
            display: inline-block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-btn:hover {
            color: #ff6b9d;
        }

        .video-section {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .video-title {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .video-title h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        .breadcrumb {
            color: #666;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #ff6b9d;
            text-decoration: none;
        }

        .video-player {
            width: 100%;
            background: #000;
            position: relative;
            aspect-ratio: 16/9;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .episode-selector {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .selector-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #2ecc71;
            border-bottom-color: #2ecc71;
        }

        .episode-range {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }

        .episode-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .episode-grid.sources-mode {
            display: block;
            gap: 0;
        }

        .episode-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .episode-btn:hover {
            border-color: #2ecc71;
            color: #2ecc71;
        }

        .episode-btn.active {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        /* è§†é¢‘æºæ ·å¼ */
        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            background: white;
        }

        .source-info {
            flex: 1;
        }

        .source-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .source-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .source-episodes {
            font-size: 11px;
            color: #999;
        }

        .source-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .source-btn:hover {
            border-color: #2ecc71;
            color: #2ecc71;
        }

        .source-btn.current {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
            cursor: default;
        }

        /* é¢‘é“åˆ—è¡¨æ ·å¼ */
        .channel-group-title {
            font-weight: bold;
            color: #333;
            padding: 10px 12px 5px;
            background: #f8f9fa;
            border-left: 3px solid #ff6b9d;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .channel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .channel-item:hover {
            border-color: #ff6b9d;
            background: #fff5f8;
        }

        .channel-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .channel-logo {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .channel-logo-placeholder {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .channel-details {
            flex: 1;
        }

        .channel-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .channel-url-short {
            font-size: 11px;
            color: #999;
            font-family: monospace;
        }

        .channel-btn {
            padding: 6px 16px;
            border: 1px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 60px;
        }

        .channel-btn:hover {
            background: #28a745;
            color: white;
        }

        .quality-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
            }

            .nav-links {
                display: none;
            }

            .episode-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            /* ç§»åŠ¨ç«¯æœç´¢æ¡†é€‚é… */
            .search-section {
                padding: 15px 10px;
            }

            .search-box {
                flex-direction: column;
                gap: 10px;
            }

            .search-input,
            .search-btn {
                width: 100%;
                max-width: none;
            }

            .search-btn {
                justify-content: center;
            }

            .search-results-info {
                font-size: 12px;
                padding: 0 5px;
            }

            /* ç§»åŠ¨ç«¯ç½‘å€è¾“å…¥æ¡†é€‚é… */
            .url-section {
                padding: 12px 10px;
            }

            .url-box {
                flex-direction: column;
                gap: 10px;
                max-width: none;
            }

            .url-input,
            .url-btn {
                width: 100%;
                max-width: none;
            }

            .url-btn {
                justify-content: center;
            }

            .url-tips {
                margin-top: 10px;
            }

            .tip-text {
                font-size: 11px;
                padding: 3px 10px;
            }

            /* ç§»åŠ¨ç«¯é¢‘é“åˆ—è¡¨é€‚é… */
            .channel-group-title {
                font-size: 12px;
                padding: 8px 10px 4px;
            }

            .channel-item {
                padding: 8px 10px;
                margin-bottom: 4px;
            }

            .channel-logo,
            .channel-logo-placeholder {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .channel-name {
                font-size: 13px;
            }

            .channel-url-short {
                font-size: 10px;
            }

            .channel-btn {
                padding: 4px 12px;
                font-size: 11px;
                min-width: 50px;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <nav class="nav">
            <a href="#" class="logo">KatelyaTV</a>

            <div class="nav-links">
                <a href="movies.html">ğŸ  é¦–é¡µ</a>
                <a href="movies.html#movie">ğŸ¬ ç”µå½±</a>
                <a href="movies.html#tv">ğŸ“º å‰§é›†</a>
                <a href="movies.html#show">ğŸ“– ç»¼è‰º</a>
            </div>

            <div class="nav-right">
                <div class="theme-toggle">ğŸŒ™</div>
                <div class="user-icon">ğŸ‘¤</div>
            </div>
        </nav>

        <div class="search-section">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ç”µå½±ã€å‰§é›†..." maxlength="50">
                    <button class="search-btn" id="searchBtn">
                        <span>ğŸ”</span>
                        <span id="searchBtnText">æœç´¢</span>
                    </button>
                </div>
            </div>
            <div class="search-results-info hidden" id="searchResultsInfo"></div>
        </div>

        <!-- ç½‘å€è¾“å…¥æ¡†åŒºåŸŸ -->
        <div class="url-section">
            <div class="url-container">
                <div class="url-box">
                    <input type="text" class="url-input" id="urlInput"
                        placeholder="è¾“å…¥è§†é¢‘ç›´é“¾æˆ–IPTVæ’­æ”¾åˆ—è¡¨åœ°å€ (æ”¯æŒm3u8ã€mp4ã€m3uæ ¼å¼)" maxlength="500">
                    <button class="url-btn" id="urlBtn">
                        <span>â–¶ï¸</span>
                        <span id="urlBtnText">æ’­æ”¾</span>
                    </button>
                </div>
                <div class="url-tips">
                    <span class="tip-text">ğŸ’¡ æ”¯æŒè§†é¢‘ç›´é“¾ (m3u8ã€mp4ã€flv) å’Œ IPTVæ’­æ”¾åˆ—è¡¨ (m3u)</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- <a href="#" class="back-btn">
                â† è¿”å›
            </a> -->

            <div class="video-section">
                <div class="video-title">
                    <h1>æ­£åœ¨åŠ è½½...</h1>
                    <div class="breadcrumb">
                        <a href="#">æ­£åœ¨åŠ è½½è§†é¢‘ä¿¡æ¯...</a>
                    </div>
                </div>

                <div class="video-player" id="player">
                    <!-- <div class="video-placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 10px;">â–¶ï¸</div>
                            <div>è§†é¢‘æ’­æ”¾å™¨</div>
                            <div style="font-size: 14px; margin-top: 5px; opacity: 0.7;">ç‚¹å‡»æ’­æ”¾</div>
                        </div>
                    </div> -->
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="episode-selector">
                <div class="selector-tabs">
                    <button class="tab active">é€‰é›†</button>
                    <button class="tab">æ¢æº</button>
                </div>

                <div class="episode-range">
                    <span>åŠ è½½ä¸­...</span>
                    <div style="margin-left: auto;">
                        <button style="background: none; border: none; cursor: pointer;">ğŸ”¼</button>
                    </div>
                </div>

                <div class="episode-grid">
                    <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                        æ­£åœ¨åŠ è½½é€‰é›†ä¿¡æ¯...
                    </div>
                </div>
            </div>

            <div class="quality-info">
                <div style="margin-bottom: 8px;">ğŸ¥ é«˜æ¸…æ’­æ”¾</div>
                <div>æ”¯æŒ1080Pé«˜æ¸…ç”»è´¨</div>
            </div>
        </aside>
    </div>

    <div class="footer">    
        <p>Copyright Â© 2025 KatelyaTV. All rights reserved.</p>
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=JpbG6sQCoIwI4LMM&ck=JpbG6sQCoIwI4LMM"></script>
    </div>

    <script>


        let adFilteringEnabled = true;
        let art = null; // ç”¨äº ArtPlayer å®ä¾‹
        let currentHls = null; // è·Ÿè¸ªå½“å‰HLSå®ä¾‹
        let progressSaveInterval = null; // å®šæœŸä¿å­˜è¿›åº¦çš„è®¡æ—¶å™¨
        let currentEpisodes = [];
        let currentVideoUrl = null;
        let videoTitle = 'è§†é¢‘æ’­æ”¾';
        let videoHasEnded = false;
        let autoplayEnabled = true;
        let userClickedPosition = null;
        let availableSources = []; // å­˜å‚¨å¯ç”¨çš„è§†é¢‘æº
        let channelList = []; // å­˜å‚¨é¢‘é“åˆ—è¡¨

        const urlParams = new URLSearchParams(window.location.search);

        const id = urlParams.get('id');
        const source = urlParams.get('source');
        const index = urlParams.get('index') || '0';
        const title = urlParams.get('title') || 'è§†é¢‘æ’­æ”¾';
        let currentEpisodeIndex = parseInt(index);

        // æ ¹æ®URLå‚æ•°æ›´æ–°é¡µé¢å†…å®¹
        function updatePageContent() {
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const episodeText = parseInt(index) > 0 ? ` ç¬¬${parseInt(index) + 1}é›†` : '';
            const pageTitle = `${title}${episodeText} - KatelyaTV`;
            document.title = pageTitle;

            // æ›´æ–°è§†é¢‘æ ‡é¢˜
            const videoTitleElement = document.querySelector('.video-title h1');
            if (videoTitleElement) {
                videoTitleElement.textContent = title;
            }

            // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
            const breadcrumbElement = document.querySelector('.breadcrumb');
            if (breadcrumbElement) {
                const episodeInfo = parseInt(index) > 0 ? ` > ç¬¬${parseInt(index) + 1}é›†` : '';
                breadcrumbElement.innerHTML = `
                    <a href="#">${title}</a>${episodeInfo}
                `;
            }

            // æ›´æ–°å…¨å±€è§†é¢‘æ ‡é¢˜å˜é‡
            videoTitle = title + episodeText;

            console.log('é¡µé¢å†…å®¹å·²æ›´æ–°:', { title, index, pageTitle });
        }

        (function () {
            updatePageContent(); // é¦–å…ˆæ›´æ–°é¡µé¢å†…å®¹
            init();
        })();


        async function getVideoUrl(id, source, index) {
            let url = `/movie/detail?id=${id}&source=${source}`;
            let response = await fetch(url);
            let data = await response.json();
            console.log(data);
            currentEpisodes = data.episodes;
            currentVideoUrl = data.episodes[index];

            // æ›´æ–°é€‰é›†æ˜¾ç¤º
            updateEpisodesDisplay(data.episodes, parseInt(index));

            return data.episodes[index];
        }

        // æ›´æ–°é€‰é›†æ˜¾ç¤º
        function updateEpisodesDisplay(episodes, currentIndex) {
            if (!episodes || !Array.isArray(episodes) || episodes.length === 0) {
                console.log('æ²¡æœ‰é€‰é›†æ•°æ®');
                return;
            }

            const episodeCount = episodes.length;
            console.log(`æ›´æ–°é€‰é›†æ˜¾ç¤º: å…±${episodeCount}é›†ï¼Œå½“å‰ç¬¬${currentIndex + 1}é›†`);

            // æ›´æ–°é€‰é›†èŒƒå›´æ˜¾ç¤º
            const episodeRange = document.querySelector('.episode-range span');
            if (episodeRange) {
                episodeRange.textContent = `1-${episodeCount}`;
            }

            // ç”Ÿæˆé€‰é›†æŒ‰é’®
            const episodeGrid = document.querySelector('.episode-grid');
            if (episodeGrid) {
                let buttonsHtml = '';
                for (let i = 0; i < episodeCount; i++) {
                    const isActive = i === currentIndex ? ' active' : '';
                    buttonsHtml += `<button class="episode-btn${isActive}" data-episode-index="${i}">${i + 1}</button>`;
                }
                episodeGrid.innerHTML = buttonsHtml;

                // ä¸ºæ¯ä¸ªé€‰é›†æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
                bindEpisodeEvents();
            }
        }

        // ç»‘å®šé€‰é›†æŒ‰é’®äº‹ä»¶
        function bindEpisodeEvents() {
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const episodeIndex = parseInt(this.getAttribute('data-episode-index'));
                    switchToEpisode(episodeIndex);
                });
            });
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šé›†æ•°
        function switchToEpisode(episodeIndex) {
            if (!currentEpisodes || episodeIndex < 0 || episodeIndex >= currentEpisodes.length) {
                console.error('æ— æ•ˆçš„é›†æ•°ç´¢å¼•:', episodeIndex);
                return;
            }

            console.log(`åˆ‡æ¢åˆ°ç¬¬${episodeIndex + 1}é›†`);

            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const targetBtn = document.querySelector(`[data-episode-index="${episodeIndex}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }

            // æ›´æ–°å…¨å±€å˜é‡
            currentEpisodeIndex = episodeIndex;
            currentVideoUrl = currentEpisodes[episodeIndex];

            // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œé¢åŒ…å±‘
            updatePageContentForEpisode(episodeIndex);

            // åˆ‡æ¢æ’­æ”¾å™¨è§†é¢‘æº
            if (art) {
                art.switchUrl(currentVideoUrl);
            }
        }

        // æœç´¢è§†é¢‘æº
        async function searchVideoSources(searchTitle) {
            try {
                console.log('æœç´¢è§†é¢‘æº:', searchTitle);
                const response = await fetch(`/movie/search?q=${encodeURIComponent(searchTitle)}`);
                const data = await response.json();

                if (data && data.results && Array.isArray(data.results)) {
                    availableSources = data.results;
                    console.log(`æ‰¾åˆ° ${availableSources.length} ä¸ªè§†é¢‘æº:`, availableSources);
                    return availableSources;
                } else {
                    console.log('æœç´¢å“åº”æ ¼å¼å¼‚å¸¸:', data);
                    return [];
                }
            } catch (error) {
                console.error('æœç´¢è§†é¢‘æºå¤±è´¥:', error);
                return [];
            }
        }

        // æ›´æ–°æ¢æºæ˜¾ç¤º
        function updateSourcesDisplay() {
            const episodeGrid = document.querySelector('.episode-grid');
            episodeGrid.classList.add('sources-mode');

            if (availableSources.length === 0) {
                episodeGrid.innerHTML = `
                    <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                        <div style="margin-bottom: 10px;">ğŸ” æ­£åœ¨æœç´¢è§†é¢‘æº...</div>
                        <div style="font-size: 14px; opacity: 0.7;">è¯·ç¨å€™</div>
                    </div>
                `;

                // å¼€å§‹æœç´¢
                searchVideoSources(title).then(sources => {
                    if (sources.length > 0) {
                        renderSourcesList(sources);
                    } else {
                        episodeGrid.innerHTML = `
                            <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                                <div style="margin-bottom: 10px;">âŒ æœªæ‰¾åˆ°å…¶ä»–è§†é¢‘æº</div>
                                <div style="font-size: 14px; opacity: 0.7;">å½“å‰ä»…æœ‰ä¸€ä¸ªæ’­æ”¾æº</div>
                            </div>
                        `;
                    }
                });
            } else {
                renderSourcesList(availableSources);
            }
        }

        // æ¸²æŸ“è§†é¢‘æºåˆ—è¡¨
        function renderSourcesList(sources) {
            const episodeGrid = document.querySelector('.episode-grid');

            let sourcesHtml = '';
            sources.forEach((sourceItem, index) => {
                const isCurrentSource = sourceItem.source === source;
                const buttonClass = isCurrentSource ? 'source-btn current' : 'source-btn';
                const buttonText = isCurrentSource ? 'å½“å‰çº¿è·¯' : 'åˆ‡æ¢';

                sourcesHtml += `
                    <div class="source-item" data-source-index="${index}">
                        <div class="source-info">
                            <div class="source-name">${sourceItem.source_name}</div>
                            <div class="source-details">${sourceItem.class} â€¢ ${sourceItem.year}</div>
                            <div class="source-episodes">${sourceItem.episodes.length}é›†</div>
                        </div>
                        <button class="${buttonClass}" data-source-index="${index}">${buttonText}</button>
                    </div>
                `;
            });

            episodeGrid.innerHTML = sourcesHtml;

            // ç»‘å®šåˆ‡æ¢äº‹ä»¶
            bindSourceSwitchEvents();
        }

        // ç»‘å®šè§†é¢‘æºåˆ‡æ¢äº‹ä»¶
        function bindSourceSwitchEvents() {
            document.querySelectorAll('.source-btn:not(.current)').forEach(btn => {
                btn.addEventListener('click', function () {
                    const sourceIndex = parseInt(this.getAttribute('data-source-index'));
                    switchToSource(sourceIndex);
                });
            });
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šè§†é¢‘æº
        function switchToSource(sourceIndex) {
            if (!availableSources || sourceIndex < 0 || sourceIndex >= availableSources.length) {
                console.error('æ— æ•ˆçš„æºç´¢å¼•:', sourceIndex);
                return;
            }

            const newSource = availableSources[sourceIndex];
            console.log('åˆ‡æ¢åˆ°è§†é¢‘æº:', newSource.source_name, newSource);

            // æ„å»ºæ–°çš„æ’­æ”¾å™¨URL
            const newUrl = `player.html?id=${newSource.id}&source=${newSource.source}&index=0&title=${encodeURIComponent(newSource.title)}`;

            // è·³è½¬åˆ°æ–°æº
            window.location.href = newUrl;
        }

        // æ›´æ–°é¡µé¢å†…å®¹ï¼ˆé’ˆå¯¹é›†æ•°åˆ‡æ¢ï¼‰
        function updatePageContentForEpisode(episodeIndex) {
            const episodeText = episodeIndex >= 0 ? ` ç¬¬${episodeIndex + 1}é›†` : '';
            const pageTitle = `${title}${episodeText} - KatelyaTV`;

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = pageTitle;

            // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
            const breadcrumbElement = document.querySelector('.breadcrumb');
            if (breadcrumbElement) {
                const episodeInfo = episodeIndex >= 0 ? ` > ç¬¬${episodeIndex + 1}é›†` : '';
                breadcrumbElement.innerHTML = `
                    <a href="#">${title}</a>${episodeInfo}
                `;
            }

            // æ›´æ–°å…¨å±€è§†é¢‘æ ‡é¢˜å˜é‡
            videoTitle = title + episodeText;

            console.log('é¡µé¢å†…å®¹å·²æ›´æ–°ä¸ºé›†æ•°:', episodeIndex + 1);
        }

        async function init() {
            // æ£€æŸ¥å¿…è¦å‚æ•°
            if (!id || !source) {
                console.error('ç¼ºå°‘å¿…è¦å‚æ•°:', { id, source, index, title });
                showError('ç¼ºå°‘è§†é¢‘IDæˆ–æ¥æºå‚æ•°');
                return;
            }

            try {
                // è·å–è§†é¢‘URL
                let videoUrl = await getVideoUrl(id, source, index);
                if (videoUrl) {
                    initPlayer(videoUrl);
                } else {
                    showError('æ— æ³•è·å–è§†é¢‘åœ°å€');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showError('è§†é¢‘åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // è‡ªå®šä¹‰M3U8 Loaderç”¨äºè¿‡æ»¤å¹¿å‘Š - ä½¿ç”¨å·¥å‚å‡½æ•°é¿å…åˆå§‹åŒ–é¡ºåºé—®é¢˜
        function createCustomHlsJsLoader() {
            if (!window.Hls || !window.Hls.DefaultConfig || !window.Hls.DefaultConfig.loader) {
                console.warn('Hls.js not properly loaded, falling back to default loader');
                return window.Hls ? window.Hls.DefaultConfig.loader : null;
            }

            class CustomHlsJsLoader extends window.Hls.DefaultConfig.loader {
                constructor(config) {
                    super(config);
                    const load = this.load.bind(this);
                    this.load = function (context, config, callbacks) {
                        // æ‹¦æˆªmanifestå’Œlevelè¯·æ±‚
                        if (context.type === 'manifest' || context.type === 'level') {
                            const onSuccess = callbacks.onSuccess;
                            callbacks.onSuccess = function (response, stats, context) {
                                // å¦‚æœæ˜¯m3u8æ–‡ä»¶ï¼Œå¤„ç†å†…å®¹ä»¥ç§»é™¤å¹¿å‘Šåˆ†æ®µ
                                if (response.data && typeof response.data === 'string') {
                                    // è¿‡æ»¤æ‰å¹¿å‘Šæ®µ - å®ç°æ›´ç²¾ç¡®çš„å¹¿å‘Šè¿‡æ»¤é€»è¾‘
                                    response.data = filterAdsFromM3U8(response.data, true);
                                }
                                return onSuccess(response, stats, context);
                            };
                        }
                        // æ‰§è¡ŒåŸå§‹loadæ–¹æ³•
                        load(context, config, callbacks);
                    };
                }
            }
            return CustomHlsJsLoader;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            console.error('Player Error:', message);
            const playerContainer = document.getElementById('player');
            if (playerContainer) {
                playerContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1a1a1a; color: white; text-align: center;">
                        <div>
                            <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                            <div style="font-size: 18px; margin-bottom: 10px;">${message}</div>
                            <div style="font-size: 14px; color: #aaa;">è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–æ›´æ¢è§†é¢‘æº</div>
                        </div>
                    </div>
                `;
            }
        }

        // è·å–è§†é¢‘IDç”¨äºè¿›åº¦ä¿å­˜
        function getVideoId() {
            const urlParams = new URLSearchParams(window.location.search);
            return `${urlParams.get('source') || 'unknown'}_${urlParams.get('id') || 'unknown'}_${urlParams.get('index') || '0'}`;
        }

        // æ˜¾ç¤ºä½ç½®æ¢å¤æç¤º
        function showPositionRestoreHint(position) {
            // ç®€å•çš„æ§åˆ¶å°æ—¥å¿—ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦å®ç°UIæç¤º
            console.log(`å·²æ¢å¤åˆ°æ’­æ”¾ä½ç½®: ${Math.floor(position)}ç§’`);
        }

        // æ˜¾ç¤ºå¿«æ·é”®æç¤º
        function showShortcutHint(text, position = 'center') {
            console.log(`å¿«æ·é”®æç¤º: ${text}`);
            
            // åˆ›å»ºæˆ–è·å–æç¤ºå…ƒç´ 
            let hintElement = document.getElementById('shortcut-hint');
            if (!hintElement) {
                hintElement = document.createElement('div');
                hintElement.id = 'shortcut-hint';
                hintElement.style.cssText = `
                    position: fixed;
                    z-index: 9999;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: 500;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    white-space: nowrap;
                `;
                document.body.appendChild(hintElement);
            }
            
            // è®¾ç½®æç¤ºæ–‡æœ¬
            hintElement.textContent = text;
            
            // æ ¹æ®ä½ç½®è®¾ç½®æ ·å¼
            switch (position) {
                case 'left':
                    hintElement.style.left = '20px';
                    hintElement.style.top = '50%';
                    hintElement.style.transform = 'translateY(-50%)';
                    hintElement.style.right = 'auto';
                    hintElement.style.bottom = 'auto';
                    break;
                case 'right':
                    hintElement.style.right = '20px';
                    hintElement.style.top = '50%';
                    hintElement.style.transform = 'translateY(-50%)';
                    hintElement.style.left = 'auto';
                    hintElement.style.bottom = 'auto';
                    break;
                case 'center':
                default:
                    hintElement.style.left = '50%';
                    hintElement.style.top = '50%';
                    hintElement.style.transform = 'translate(-50%, -50%)';
                    hintElement.style.right = 'auto';
                    hintElement.style.bottom = 'auto';
                    break;
            }
            
            // æ˜¾ç¤ºæç¤º
            hintElement.style.opacity = '1';
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (window.hintTimer) {
                clearTimeout(window.hintTimer);
            }
            
            // 1.5ç§’åéšè—æç¤º
            window.hintTimer = setTimeout(() => {
                hintElement.style.opacity = '0';
            }, 1500);
        }

        // æ¸…é™¤è§†é¢‘æ’­æ”¾è¿›åº¦
        function clearVideoProgress() {
            try {
                const progressKey = 'videoProgress_' + getVideoId();
                localStorage.removeItem(progressKey);
            } catch (e) {
                console.error('Failed to clear video progress:', e);
            }
        }

        // æ’­æ”¾ä¸‹ä¸€é›†
        function playNextEpisode() {
            const nextIndex = parseInt(currentEpisodeIndex) + 1;
            if (nextIndex < currentEpisodes.length) {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('index', nextIndex);
                window.location.href = window.location.pathname + '?' + urlParams.toString();
            }
        }

        // å®‰å…¨åœ°éšè—å…ƒç´ 
        function safeHideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        // å®‰å…¨åœ°æ˜¾ç¤ºå…ƒç´ 
        function safeShowElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
            }
        }

        // è¿‡æ»¤å¯ç–‘çš„å¹¿å‘Šå†…å®¹
        function filterAdsFromM3U8(m3u8Content, strictMode = false) {
            if (!m3u8Content) return '';

            // æŒ‰è¡Œåˆ†å‰²M3U8å†…å®¹
            const lines = m3u8Content.split('\n');
            const filteredLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // åªè¿‡æ»¤#EXT-X-DISCONTINUITYæ ‡è¯†
                if (!line.includes('#EXT-X-DISCONTINUITY')) {
                    filteredLines.push(line);
                }
            }

            return filteredLines.join('\n');
        }


        // åˆå§‹åŒ–æ’­æ”¾å™¨
        function initPlayer(videoUrl) {
            if (!videoUrl) {
                return
            }

            // é”€æ¯æ—§å®ä¾‹
            if (art) {
                art.destroy();
                art = null;
            }
            
            // æ¸…ç†é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('keydown', handleKeyboardEvent);

            // é…ç½®HLS.jsé€‰é¡¹
            const CustomLoader = adFilteringEnabled ? createCustomHlsJsLoader() : null;
            const hlsConfig = {
                debug: false,
                loader: CustomLoader || (window.Hls ? window.Hls.DefaultConfig.loader : undefined),
                enableWorker: true,
                lowLatencyMode: false,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 60,
                maxBufferSize: 30 * 1000 * 1000,
                maxBufferHole: 0.5,
                fragLoadingMaxRetry: 6,
                fragLoadingMaxRetryTimeout: 64000,
                fragLoadingRetryDelay: 1000,
                manifestLoadingMaxRetry: 3,
                manifestLoadingRetryDelay: 1000,
                levelLoadingMaxRetry: 4,
                levelLoadingRetryDelay: 1000,
                startLevel: -1,
                abrEwmaDefaultEstimate: 500000,
                abrBandWidthFactor: 0.95,
                abrBandWidthUpFactor: 0.7,
                abrMaxWithRealBitrate: true,
                stretchShortVideoTrack: true,
                appendErrorMaxRetry: 5,  // å¢åŠ å°è¯•æ¬¡æ•°
                liveSyncDurationCount: 3,
                liveDurationInfinity: false
            };

            // Create new ArtPlayer instance
            art = new Artplayer({
                container: '#player',
                url: videoUrl,
                type: 'm3u8',
                title: videoTitle,
                volume: 0.8,
                isLive: false,
                muted: false,
                autoplay: true,
                pip: true,
                autoSize: false,
                autoMini: true,
                screenshot: true,
                setting: true,
                loop: false,
                flip: false,
                playbackRate: true,
                aspectRatio: false,
                fullscreen: true,
                fullscreenWeb: true,
                subtitleOffset: false,
                miniProgressBar: true,
                mutex: true,
                backdrop: true,
                playsInline: true,
                autoPlayback: false,
                airplay: true,
                hotkey: false,
                theme: '#23ade5',
                lang: navigator.language.toLowerCase(),
                moreVideoAttr: {
                    crossOrigin: 'anonymous',
                },
                customType: {
                    m3u8: function (video, url) {
                        // æ¸…ç†ä¹‹å‰çš„HLSå®ä¾‹
                        if (currentHls && currentHls.destroy) {
                            try {
                                currentHls.destroy();
                            } catch (e) {
                            }
                        }

                        // æ£€æŸ¥HLSåº“æ˜¯å¦æ­£ç¡®åŠ è½½
                        if (!window.Hls) {
                            console.error('Hls.js library not loaded');
                            showError('è§†é¢‘æ’­æ”¾åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                            return;
                        }

                        // åˆ›å»ºæ–°çš„HLSå®ä¾‹
                        const hls = new window.Hls(hlsConfig);
                        currentHls = hls;

                        // è·Ÿè¸ªæ˜¯å¦å·²ç»æ˜¾ç¤ºé”™è¯¯
                        let errorDisplayed = false;
                        // è·Ÿè¸ªæ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿ
                        let errorCount = 0;
                        // è·Ÿè¸ªè§†é¢‘æ˜¯å¦å¼€å§‹æ’­æ”¾
                        let playbackStarted = false;
                        // è·Ÿè¸ªè§†é¢‘æ˜¯å¦å‡ºç°bufferAppendError
                        let bufferAppendErrorCount = 0;

                        // ç›‘å¬è§†é¢‘æ’­æ”¾äº‹ä»¶
                        video.addEventListener('playing', function () {
                            playbackStarted = true;
                            safeHideElement('player-loading');
                            safeHideElement('error');
                        });

                        // ç›‘å¬è§†é¢‘è¿›åº¦äº‹ä»¶
                        video.addEventListener('timeupdate', function () {
                            if (video.currentTime > 1) {
                                // è§†é¢‘è¿›åº¦è¶…è¿‡1ç§’ï¼Œéšè—é”™è¯¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                safeHideElement('error');
                            }
                        });

                        hls.loadSource(url);
                        hls.attachMedia(video);

                        // enable airplay, from https://github.com/video-dev/hls.js/issues/5989
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨sourceå…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
                        let sourceElement = video.querySelector('source');
                        if (sourceElement) {
                            // æ›´æ–°ç°æœ‰sourceå…ƒç´ çš„URL
                            sourceElement.src = videoUrl;
                        } else {
                            // åˆ›å»ºæ–°çš„sourceå…ƒç´ 
                            sourceElement = document.createElement('source');
                            sourceElement.src = videoUrl;
                            video.appendChild(sourceElement);
                        }
                        video.disableRemotePlayback = false;

                        hls.on(window.Hls.Events.MANIFEST_PARSED, function () {
                            video.play().catch(e => {
                            });
                        });

                        hls.on(window.Hls.Events.ERROR, function (event, data) {
                            // å¢åŠ é”™è¯¯è®¡æ•°
                            errorCount++;

                            // å¤„ç†bufferAppendError
                            if (data.details === 'bufferAppendError') {
                                bufferAppendErrorCount++;
                                // å¦‚æœè§†é¢‘å·²ç»å¼€å§‹æ’­æ”¾ï¼Œåˆ™å¿½ç•¥è¿™ä¸ªé”™è¯¯
                                if (playbackStarted) {
                                    return;
                                }

                                // å¦‚æœå‡ºç°å¤šæ¬¡bufferAppendErrorä½†è§†é¢‘æœªæ’­æ”¾ï¼Œå°è¯•æ¢å¤
                                if (bufferAppendErrorCount >= 3) {
                                    hls.recoverMediaError();
                                }
                            }

                            // å¦‚æœæ˜¯è‡´å‘½é”™è¯¯ï¼Œä¸”è§†é¢‘æœªæ’­æ”¾
                            if (data.fatal && !playbackStarted) {
                                // å°è¯•æ¢å¤é”™è¯¯
                                switch (data.type) {
                                    case window.Hls.ErrorTypes.NETWORK_ERROR:
                                        hls.startLoad();
                                        break;
                                    case window.Hls.ErrorTypes.MEDIA_ERROR:
                                        hls.recoverMediaError();
                                        break;
                                    default:
                                        // ä»…åœ¨å¤šæ¬¡æ¢å¤å°è¯•åæ˜¾ç¤ºé”™è¯¯
                                        if (errorCount > 3 && !errorDisplayed) {
                                            errorDisplayed = true;
                                            showError('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ ¼å¼ä¸å…¼å®¹æˆ–æºä¸å¯ç”¨');
                                        }
                                        break;
                                }
                            }
                        });

                        // ç›‘å¬åˆ†æ®µåŠ è½½äº‹ä»¶
                        hls.on(window.Hls.Events.FRAG_LOADED, function () {
                            safeHideElement('player-loading');
                        });

                        // ç›‘å¬çº§åˆ«åŠ è½½äº‹ä»¶
                        hls.on(window.Hls.Events.LEVEL_LOADED, function () {
                            safeHideElement('player-loading');
                        });
                    }
                }
            });


            // artplayer æ²¡æœ‰ 'fullscreenWeb:enter', 'fullscreenWeb:exit' ç­‰äº‹ä»¶
            // æ‰€ä»¥åŸæ§åˆ¶æ éšè—ä»£ç å¹¶æ²¡æœ‰èµ·ä½œç”¨
            // å®é™…èµ·ä½œç”¨çš„æ˜¯ artplayer é»˜è®¤è¡Œä¸ºï¼Œå®ƒæ”¯æŒè‡ªåŠ¨éšè—å·¥å…·æ 
            // ä½†æœ‰ä¸€ä¸ª bugï¼š åœ¨å‰¯å±å…¨å±æ—¶ï¼Œé¼ æ ‡ç§»å‡ºå‰¯å±åä¸ä¼šè‡ªåŠ¨éšè—å·¥å…·æ 
            // ä¸‹é¢è¿›ä¸€å¹¶é‡æ„å’Œä¿®å¤ï¼š
            let hideTimer;

            // éšè—æ§åˆ¶æ 
            function hideControls() {
                if (art && art.controls) {
                    art.controls.show = false;
                }
            }

            // é‡ç½®è®¡æ—¶å™¨ï¼Œè®¡æ—¶å™¨è¶…æ—¶æ—¶é—´ä¸ artplayer ä¿æŒä¸€è‡´
            function resetHideTimer() {
                clearTimeout(hideTimer);
                hideTimer = setTimeout(() => {
                    hideControls();
                }, Artplayer.CONTROL_HIDE_TIME);
            }

            // å¤„ç†é¼ æ ‡ç¦»å¼€æµè§ˆå™¨çª—å£
            function handleMouseOut(e) {
                if (e && !e.relatedTarget) {
                    resetHideTimer();
                }
            }

            // å…¨å±çŠ¶æ€åˆ‡æ¢æ—¶æ³¨å†Œ/ç§»é™¤ mouseout äº‹ä»¶ï¼Œç›‘å¬é¼ æ ‡ç§»å‡ºå±å¹•äº‹ä»¶
            // ä»è€Œå¯¹æ’­æ”¾å™¨çŠ¶æ€æ è¿›è¡Œéšè—å€’è®¡æ—¶
            function handleFullScreen(isFullScreen, isWeb) {
                if (isFullScreen) {
                    document.addEventListener('mouseout', handleMouseOut);
                } else {
                    document.removeEventListener('mouseout', handleMouseOut);
                    // é€€å‡ºå…¨å±æ—¶æ¸…ç†è®¡æ—¶å™¨
                    clearTimeout(hideTimer);
                }

                if (!isWeb) {
                    if (window.screen.orientation && window.screen.orientation.lock) {
                        window.screen.orientation.lock('landscape')
                            .then(() => {
                            })
                            .catch((error) => {
                            });
                    }
                }
            }

            // æ’­æ”¾å™¨åŠ è½½å®Œæˆååˆå§‹éšè—å·¥å…·æ 
            art.on('ready', () => {
                hideControls();
            });

            // å…¨å± Web æ¨¡å¼å¤„ç†
            art.on('fullscreenWeb', function (isFullScreen) {
                handleFullScreen(isFullScreen, true);
            });

            // å…¨å±æ¨¡å¼å¤„ç†
            art.on('fullscreen', function (isFullScreen) {
                handleFullScreen(isFullScreen, false);
            });

            art.on('video:loadedmetadata', function () {
                safeHideElement('player-loading');
                videoHasEnded = false; // è§†é¢‘åŠ è½½æ—¶é‡ç½®ç»“æŸæ ‡å¿—
                // ä¼˜å…ˆä½¿ç”¨URLä¼ é€’çš„positionå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const savedPosition = parseInt(urlParams.get('position') || '0');

                if (savedPosition > 10 && savedPosition < art.duration - 2) {
                    // å¦‚æœURLä¸­æœ‰æœ‰æ•ˆçš„æ’­æ”¾ä½ç½®å‚æ•°ï¼Œç›´æ¥ä½¿ç”¨å®ƒ
                    art.currentTime = savedPosition;
                    showPositionRestoreHint(savedPosition);
                } else {
                    // å¦åˆ™å°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ’­æ”¾è¿›åº¦
                    try {
                        const progressKey = 'videoProgress_' + getVideoId();
                        const progressStr = localStorage.getItem(progressKey);
                        if (progressStr && art.duration > 0) {
                            const progress = JSON.parse(progressStr);
                            if (
                                progress &&
                                typeof progress.position === 'number' &&
                                progress.position > 10 &&
                                progress.position < art.duration - 2
                            ) {
                                art.currentTime = progress.position;
                                showPositionRestoreHint(progress.position);
                            }
                        }
                    } catch (e) {
                    }
                }

                // è®¾ç½®è¿›åº¦æ¡ç‚¹å‡»ç›‘å¬
                setupProgressBarPreciseClicks();

                // è§†é¢‘åŠ è½½æˆåŠŸåï¼Œåœ¨ç¨å¾®å»¶è¿Ÿåå°†å…¶æ·»åŠ åˆ°è§‚çœ‹å†å²
                setTimeout(saveToHistory, 3000);

                // å¯åŠ¨å®šæœŸä¿å­˜æ’­æ”¾è¿›åº¦
                startProgressSaveInterval();
            })

            // é”™è¯¯å¤„ç†
            art.on('video:error', function (error) {
                // å¦‚æœæ­£åœ¨åˆ‡æ¢è§†é¢‘ï¼Œå¿½ç•¥é”™è¯¯
                if (window.isSwitchingVideo) {
                    return;
                }

                // éšè—æ‰€æœ‰åŠ è½½æŒ‡ç¤ºå™¨
                const loadingElements = document.querySelectorAll('#player-loading, .player-loading-container');
                loadingElements.forEach(el => {
                    if (el) el.style.display = 'none';
                });

                showError('è§†é¢‘æ’­æ”¾å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            });

            // æ·»åŠ ç§»åŠ¨ç«¯é•¿æŒ‰ä¸‰å€é€Ÿæ’­æ”¾åŠŸèƒ½
            setupLongPressSpeedControl();

            // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
            setupKeyboardControls();

            // è§†é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
            art.on('video:ended', function () {
                videoHasEnded = true;

                clearVideoProgress();

                // å¦‚æœè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é›†å¼€å¯ï¼Œä¸”ç¡®å®æœ‰ä¸‹ä¸€é›†
                if (autoplayEnabled && currentEpisodeIndex < currentEpisodes.length - 1) {
                    // ç¨é•¿å»¶è¿Ÿä»¥ç¡®ä¿æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæˆ
                    setTimeout(() => {
                        // ç¡®è®¤ä¸æ˜¯å› ä¸ºç”¨æˆ·æ‹–æ‹½å¯¼è‡´çš„å‡ç»“æŸäº‹ä»¶
                        playNextEpisode();
                        videoHasEnded = false; // é‡ç½®æ ‡å¿—
                    }, 1000);
                } else {
                    art.fullscreen = false;
                }
            });

            // æ·»åŠ åŒå‡»å…¨å±æ”¯æŒ
            art.on('video:playing', () => {
                // ç»‘å®šåŒå‡»äº‹ä»¶åˆ°è§†é¢‘å®¹å™¨
                if (art.video) {
                    art.video.addEventListener('dblclick', () => {
                        art.fullscreen = !art.fullscreen;
                        art.play();
                    });
                }
            });

            // 10ç§’åå¦‚æœä»åœ¨åŠ è½½ï¼Œä½†ä¸ç«‹å³æ˜¾ç¤ºé”™è¯¯
            setTimeout(function () {
                // å¦‚æœè§†é¢‘å·²ç»æ’­æ”¾å¼€å§‹ï¼Œåˆ™ä¸æ˜¾ç¤ºé”™è¯¯
                if (art && art.video && art.video.currentTime > 0) {
                    return;
                }

                const loadingElement = document.getElementById('player-loading');
                if (loadingElement && loadingElement.style.display !== 'none') {
                    loadingElement.innerHTML = `
            <div class="loading-spinner"></div>
            <div>è§†é¢‘åŠ è½½æ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…...</div>
            <div style="font-size: 12px; color: #aaa; margin-top: 10px;">å¦‚é•¿æ—¶é—´æ— å“åº”ï¼Œè¯·å°è¯•å…¶ä»–è§†é¢‘æº</div>
        `;
                }
            }, 10000);
        }

        // å…¨å±€é”®ç›˜äº‹ä»¶å¤„ç†å‡½æ•°
        function handleKeyboardEvent(e) {
            // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†ä¸­ï¼Œå¦‚æœæ˜¯åˆ™ä¸å¤„ç†å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // æ£€æŸ¥æ’­æ”¾å™¨æ˜¯å¦å­˜åœ¨ä¸”è§†é¢‘å·²åŠ è½½
            if (!art || !art.video || art.video.duration === 0) {
                return;
            }
            
            switch (e.key) {
                case 'ArrowLeft':
                    // å·¦æ–¹å‘é”®ï¼šåé€€5ç§’
                    e.preventDefault();
                    const newTimeLeft = Math.max(0, art.video.currentTime - 5);
                    art.currentTime = newTimeLeft;
                    showShortcutHint('åé€€ 5 ç§’', 'left');
                    break;
                    
                case 'ArrowRight':
                    // å³æ–¹å‘é”®ï¼šå¿«è¿›5ç§’
                    e.preventDefault();
                    const newTimeRight = Math.min(art.video.duration - 1, art.video.currentTime + 5);
                    art.currentTime = newTimeRight;
                    showShortcutHint('å¿«è¿› 5 ç§’', 'right');
                    break;
                    
                case 'ArrowUp':
                    // ä¸Šæ–¹å‘é”®ï¼šéŸ³é‡å¢åŠ 10%
                    e.preventDefault();
                    const newVolumeUp = Math.min(1, art.volume + 0.1);
                    art.volume = newVolumeUp;
                    showShortcutHint(`éŸ³é‡ ${Math.round(newVolumeUp * 100)}%`, 'center');
                    break;
                    
                case 'ArrowDown':
                    // ä¸‹æ–¹å‘é”®ï¼šéŸ³é‡å‡å°‘10%
                    e.preventDefault();
                    const newVolumeDown = Math.max(0, art.volume - 0.1);
                    art.volume = newVolumeDown;
                    showShortcutHint(`éŸ³é‡ ${Math.round(newVolumeDown * 100)}%`, 'center');
                    break;
                    
                case ' ':
                    // ç©ºæ ¼é”®ï¼šæ’­æ”¾/æš‚åœ
                    e.preventDefault();
                    if (art.video.paused) {
                        art.play();
                        showShortcutHint('æ’­æ”¾', 'center');
                    } else {
                        art.pause();
                        showShortcutHint('æš‚åœ', 'center');
                    }
                    break;
                    
                case 'f':
                case 'F':
                    // Fé”®ï¼šå…¨å±åˆ‡æ¢
                    e.preventDefault();
                    art.fullscreen = !art.fullscreen;
                    showShortcutHint(art.fullscreen ? 'è¿›å…¥å…¨å±' : 'é€€å‡ºå…¨å±', 'center');
                    break;
                    
                case 'm':
                case 'M':
                    // Mé”®ï¼šé™éŸ³åˆ‡æ¢
                    e.preventDefault();
                    art.muted = !art.muted;
                    showShortcutHint(art.muted ? 'é™éŸ³' : 'å–æ¶ˆé™éŸ³', 'center');
                    break;
            }
        }

        // è®¾ç½®é”®ç›˜å¿«æ·é”®æ§åˆ¶
        function setupKeyboardControls() {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('keydown', handleKeyboardEvent);
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('keydown', handleKeyboardEvent);
        }

        // è®¾ç½®ç§»åŠ¨ç«¯é•¿æŒ‰ä¸‰å€é€Ÿæ’­æ”¾åŠŸèƒ½
        function setupLongPressSpeedControl() {
            if (!art || !art.video) return;

            const playerElement = document.getElementById('player');
            let longPressTimer = null;
            let originalPlaybackRate = 1.0;
            let isLongPress = false;

            // æ˜¾ç¤ºå¿«é€Ÿæç¤º
            function showSpeedHint(speed) {
                showShortcutHint(`${speed}å€é€Ÿ`, 'right');
            }

            // ç¦ç”¨å³é”®
            playerElement.oncontextmenu = () => {
                // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                // åªåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šç¦ç”¨å³é”®
                if (isMobile) {
                    const dplayerMenu = document.querySelector(".dplayer-menu");
                    const dplayerMask = document.querySelector(".dplayer-mask");
                    if (dplayerMenu) dplayerMenu.style.display = "none";
                    if (dplayerMask) dplayerMask.style.display = "none";
                    return false;
                }
                return true; // åœ¨æ¡Œé¢è®¾å¤‡ä¸Šå…è®¸å³é”®èœå•
            };

            // è§¦æ‘¸å¼€å§‹äº‹ä»¶
            playerElement.addEventListener('touchstart', function (e) {
                // æ£€æŸ¥è§†é¢‘æ˜¯å¦æ­£åœ¨æ’­æ”¾ï¼Œå¦‚æœæ²¡æœ‰æ’­æ”¾åˆ™ä¸è§¦å‘é•¿æŒ‰åŠŸèƒ½
                if (art.video.paused) {
                    return; // è§†é¢‘æš‚åœæ—¶ä¸è§¦å‘é•¿æŒ‰åŠŸèƒ½
                }

                // ä¿å­˜åŸå§‹æ’­æ”¾é€Ÿåº¦
                originalPlaybackRate = art.video.playbackRate;

                // è®¾ç½®é•¿æŒ‰è®¡æ—¶å™¨
                longPressTimer = setTimeout(() => {
                    // å†æ¬¡æ£€æŸ¥è§†é¢‘æ˜¯å¦ä»åœ¨æ’­æ”¾
                    if (art.video.paused) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                        return;
                    }

                    // é•¿æŒ‰è¶…è¿‡500msï¼Œè®¾ç½®ä¸º3å€é€Ÿ
                    art.video.playbackRate = 3.0;
                    isLongPress = true;
                    showSpeedHint(3.0);

                    // åªåœ¨ç¡®è®¤ä¸ºé•¿æŒ‰æ—¶é˜»æ­¢é»˜è®¤è¡Œä¸º
                    e.preventDefault();
                }, 500);
            }, { passive: false });

            // è§¦æ‘¸ç»“æŸäº‹ä»¶
            playerElement.addEventListener('touchend', function (e) {
                // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // å¦‚æœæ˜¯é•¿æŒ‰çŠ¶æ€ï¼Œæ¢å¤åŸå§‹æ’­æ”¾é€Ÿåº¦
                if (isLongPress) {
                    art.video.playbackRate = originalPlaybackRate;
                    isLongPress = false;
                    showSpeedHint(originalPlaybackRate);

                    // é˜»æ­¢é•¿æŒ‰åçš„ç‚¹å‡»äº‹ä»¶
                    e.preventDefault();
                }
                // å¦‚æœä¸æ˜¯é•¿æŒ‰ï¼Œåˆ™å…è®¸æ­£å¸¸çš„ç‚¹å‡»äº‹ä»¶ï¼ˆæš‚åœ/æ’­æ”¾ï¼‰
            });

            // è§¦æ‘¸å–æ¶ˆäº‹ä»¶
            playerElement.addEventListener('touchcancel', function () {
                // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // å¦‚æœæ˜¯é•¿æŒ‰çŠ¶æ€ï¼Œæ¢å¤åŸå§‹æ’­æ”¾é€Ÿåº¦
                if (isLongPress) {
                    art.video.playbackRate = originalPlaybackRate;
                    isLongPress = false;
                }
            });

            // è§¦æ‘¸ç§»åŠ¨äº‹ä»¶ - é˜²æ­¢åœ¨é•¿æŒ‰æ—¶è§¦å‘é¡µé¢æ»šåŠ¨
            playerElement.addEventListener('touchmove', function (e) {
                if (isLongPress) {
                    e.preventDefault();
                }
            }, { passive: false });

            // è§†é¢‘æš‚åœæ—¶å–æ¶ˆé•¿æŒ‰çŠ¶æ€
            art.video.addEventListener('pause', function () {
                if (isLongPress) {
                    art.video.playbackRate = originalPlaybackRate;
                    isLongPress = false;
                }

                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });
        }


        // è®¾ç½®è¿›åº¦æ¡å‡†ç¡®ç‚¹å‡»å¤„ç†
        function setupProgressBarPreciseClicks() {
            // æŸ¥æ‰¾DPlayerçš„è¿›åº¦æ¡å…ƒç´ 
            const progressBar = document.querySelector('.dplayer-bar-wrap');
            if (!progressBar || !art || !art.video) return;

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            progressBar.removeEventListener('mousedown', handleProgressBarClick);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            progressBar.addEventListener('mousedown', handleProgressBarClick);

            // åœ¨ç§»åŠ¨ç«¯ä¹Ÿæ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            progressBar.removeEventListener('touchstart', handleProgressBarTouch);
            progressBar.addEventListener('touchstart', handleProgressBarTouch);

            // å¤„ç†è¿›åº¦æ¡ç‚¹å‡»
            function handleProgressBarClick(e) {
                if (!art || !art.video) return;

                // è®¡ç®—ç‚¹å‡»ä½ç½®ç›¸å¯¹äºè¿›åº¦æ¡çš„æ¯”ä¾‹
                const rect = e.currentTarget.getBoundingClientRect();
                const percentage = (e.clientX - rect.left) / rect.width;

                // è®¡ç®—ç‚¹å‡»ä½ç½®å¯¹åº”çš„è§†é¢‘æ—¶é—´
                const duration = art.video.duration;
                let clickTime = percentage * duration;

                // å¤„ç†è§†é¢‘æ¥è¿‘ç»“å°¾çš„æƒ…å†µ
                if (duration - clickTime < 1) {
                    // å¦‚æœç‚¹å‡»ä½ç½®éå¸¸æ¥è¿‘ç»“å°¾ï¼Œç¨å¾®å¾€å‰ç§»ä¸€ç‚¹
                    clickTime = Math.min(clickTime, duration - 1.5);

                }

                // è®°å½•ç”¨æˆ·ç‚¹å‡»çš„ä½ç½®
                userClickedPosition = clickTime;

                // é˜»æ­¢é»˜è®¤äº‹ä»¶ä¼ æ’­ï¼Œé¿å…DPlayerå†…éƒ¨é€»è¾‘å°†è§†é¢‘è·³è‡³æœ«å°¾
                e.stopPropagation();

                // ç›´æ¥è®¾ç½®è§†é¢‘æ—¶é—´
                art.currentTime = clickTime;
            }

            // å¤„ç†ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
            function handleProgressBarTouch(e) {
                if (!art || !art.video || !e.touches[0]) return;

                const touch = e.touches[0];
                const rect = e.currentTarget.getBoundingClientRect();
                const percentage = (touch.clientX - rect.left) / rect.width;

                const duration = art.video.duration;
                let clickTime = percentage * duration;

                // å¤„ç†è§†é¢‘æ¥è¿‘ç»“å°¾çš„æƒ…å†µ
                if (duration - clickTime < 1) {
                    clickTime = Math.min(clickTime, duration - 1.5);
                }

                // è®°å½•ç”¨æˆ·ç‚¹å‡»çš„ä½ç½®
                userClickedPosition = clickTime;

                e.stopPropagation();
                art.currentTime = clickTime;
            }
        }


        // åœ¨æ’­æ”¾å™¨åˆå§‹åŒ–åæ·»åŠ è§†é¢‘åˆ°å†å²è®°å½•
        function saveToHistory() {
            // ç¡®ä¿ currentEpisodes éç©ºä¸”æœ‰å½“å‰è§†é¢‘URL
            if (!currentEpisodes || currentEpisodes.length === 0 || !currentVideoUrl) {
                return;
            }

            // å°è¯•ä»URLä¸­è·å–å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const sourceName = urlParams.get('source') || '';
            const sourceCode = urlParams.get('source') || '';
            const id_from_params = urlParams.get('id'); // Get video ID from player URL (passed as 'id')

            // è·å–å½“å‰æ’­æ”¾è¿›åº¦
            let currentPosition = 0;
            let videoDuration = 0;

            if (art && art.video) {
                currentPosition = art.video.currentTime;
                videoDuration = art.video.duration;
            }

            // Define a show identifier: Prioritize sourceName_id, fallback to first episode URL or current video URL
            let show_identifier_for_video_info;
            if (sourceName && id_from_params) {
                show_identifier_for_video_info = `${sourceName}_${id_from_params}`;
            } else {
                show_identifier_for_video_info = (currentEpisodes && currentEpisodes.length > 0) ? currentEpisodes[0] : currentVideoUrl;
            }

            // æ„å»ºè¦ä¿å­˜çš„è§†é¢‘ä¿¡æ¯å¯¹è±¡
            const videoInfo = {
                title: "123",
                directVideoUrl: currentVideoUrl, // Current episode's direct URL
                url: `player.html?url=&source=${encodeURIComponent(sourceName)}&id=${encodeURIComponent(id_from_params || '')}&index=${index}&position=${Math.floor(currentPosition || 0)}`,
                episodeIndex: currentEpisodeIndex,
                sourceName: sourceName,
                vod_id: id_from_params || '', // Store the ID from params as vod_id in history item
                sourceCode: sourceCode,
                showIdentifier: show_identifier_for_video_info, // Identifier for the show/series
                timestamp: Date.now(),
                playbackPosition: currentPosition,
                duration: videoDuration,
                episodes: currentEpisodes && currentEpisodes.length > 0 ? [...currentEpisodes] : []
            };

            try {
                const history = JSON.parse(localStorage.getItem('viewingHistory') || '[]');

                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„ç³»åˆ—è®°å½• (åŸºäºæ ‡é¢˜ã€æ¥æºå’Œ showIdentifier)
                const existingIndex = history.findIndex(item =>
                    item.title === videoInfo.title &&
                    item.sourceName === videoInfo.sourceName &&
                    item.showIdentifier === videoInfo.showIdentifier
                );

                if (existingIndex !== -1) {
                    // å­˜åœ¨åˆ™æ›´æ–°ç°æœ‰è®°å½•çš„å½“å‰é›†æ•°ã€æ—¶é—´æˆ³ã€æ’­æ”¾è¿›åº¦å’ŒURLç­‰
                    const existingItem = history[existingIndex];
                    existingItem.episodeIndex = videoInfo.episodeIndex;
                    existingItem.timestamp = videoInfo.timestamp;
                    existingItem.sourceName = videoInfo.sourceName; // Should be consistent, but update just in case
                    existingItem.sourceCode = videoInfo.sourceCode;
                    existingItem.vod_id = videoInfo.vod_id;

                    // Update URLs to reflect the current episode being watched
                    existingItem.directVideoUrl = videoInfo.directVideoUrl; // Current episode's direct URL
                    existingItem.url = videoInfo.url; // Player link for the current episode

                    // æ›´æ–°æ’­æ”¾è¿›åº¦ä¿¡æ¯
                    existingItem.playbackPosition = videoInfo.playbackPosition > 10 ? videoInfo.playbackPosition : (existingItem.playbackPosition || 0);
                    existingItem.duration = videoInfo.duration || existingItem.duration;

                    // æ›´æ–°é›†æ•°åˆ—è¡¨ï¼ˆå¦‚æœæ–°çš„é›†æ•°åˆ—è¡¨ä¸å­˜å‚¨çš„ä¸åŒï¼Œä¾‹å¦‚é›†æ•°å¢åŠ äº†ï¼‰
                    if (videoInfo.episodes && videoInfo.episodes.length > 0) {
                        if (!existingItem.episodes ||
                            !Array.isArray(existingItem.episodes) ||
                            existingItem.episodes.length !== videoInfo.episodes.length ||
                            !videoInfo.episodes.every((ep, i) => ep === existingItem.episodes[i])) { // Basic check for content change
                            existingItem.episodes = [...videoInfo.episodes]; // Deep copy
                        }
                    }

                    // ç§»åˆ°æœ€å‰é¢
                    const updatedItem = history.splice(existingIndex, 1)[0];
                    history.unshift(updatedItem);
                } else {
                    // æ·»åŠ æ–°è®°å½•åˆ°æœ€å‰é¢
                    history.unshift(videoInfo);
                }

                // é™åˆ¶å†å²è®°å½•æ•°é‡ä¸º50æ¡
                if (history.length > 50) history.splice(50);

                localStorage.setItem('viewingHistory', JSON.stringify(history));
            } catch (e) {
            }
        }

        // å¼€å§‹å®šæœŸä¿å­˜æ’­æ”¾è¿›åº¦
        function startProgressSaveInterval() {
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
            }

            // æ¯30ç§’ä¿å­˜ä¸€æ¬¡æ’­æ”¾è¿›åº¦
            //progressSaveInterval = setInterval(saveCurrentProgress, 30000);
        }

        // é€‰é›†åˆ‡æ¢åŠŸèƒ½ç°åœ¨ç”±åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®å¤„ç†ï¼ˆåœ¨ updateEpisodesDisplay å’Œ bindEpisodeEvents å‡½æ•°ä¸­ï¼‰

        // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                if (this.textContent === 'æ¢æº') {
                    // åˆ‡æ¢åˆ°æ¢æºæ ‡ç­¾
                    document.querySelector('.episode-range').style.display = 'none';
                    updateSourcesDisplay();
                } else {
                    // åˆ‡æ¢å›é€‰é›†æ ‡ç­¾ï¼Œæ¢å¤é€‰é›†æ˜¾ç¤º
                    document.querySelector('.episode-range').style.display = 'flex';

                    // ç§»é™¤æ¢æºæ¨¡å¼çš„CSSç±»
                    const episodeGrid = document.querySelector('.episode-grid');
                    episodeGrid.classList.remove('sources-mode');

                    // ä½¿ç”¨åŠ¨æ€é€‰é›†æ˜¾ç¤ºåŠŸèƒ½
                    if (currentEpisodes && currentEpisodes.length > 0) {
                        updateEpisodesDisplay(currentEpisodes, currentEpisodeIndex);
                    } else {
                        // å¦‚æœæ²¡æœ‰é€‰é›†æ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
                        episodeGrid.innerHTML = `
                            <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                                æ­£åœ¨åŠ è½½é€‰é›†ä¿¡æ¯...
                            </div>
                        `;
                    }
                }
            });
        });

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        document.querySelector('.theme-toggle').addEventListener('click', function () {
            document.body.style.filter = document.body.style.filter ? '' : 'invert(1) hue-rotate(180deg)';
            this.textContent = this.textContent === 'ğŸŒ™' ? 'â˜€ï¸' : 'ğŸŒ™';
        });

        // ç½‘å€è¾“å…¥æ¡†åŠŸèƒ½
        const urlInput = document.getElementById('urlInput');
        const urlBtn = document.getElementById('urlBtn');
        const urlBtnText = document.getElementById('urlBtnText');

        async function playDirectUrl(url) {
            if (!url || !url.trim()) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘åœ°å€');
                return;
            }

            url = url.trim();
            console.log('å¤„ç†è¾“å…¥åœ°å€:', url);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            urlBtn.classList.add('loading');
            urlBtnText.textContent = 'åŠ è½½ä¸­...';

            try {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç›´æ¥è§†é¢‘é“¾æ¥
                if (isDirectVideoUrl(url)) {
                    console.log('æ£€æµ‹åˆ°ç›´æ¥è§†é¢‘é“¾æ¥');
                    playVideoDirectly(url);
                } else {
                    console.log('æ£€æµ‹åˆ°å¯èƒ½æ˜¯æ’­æ”¾åˆ—è¡¨ï¼Œå°è¯•è·å–å†…å®¹');
                    try {
                        // å°è¯•ç›´æ¥è·å–URLå†…å®¹
                        let response, content;
                        try {
                            response = await fetch(url, {
                                mode: 'cors',
                                headers: {
                                    'Accept': 'text/plain, application/x-mpegURL, */*'
                                }
                            });
                            content = await response.text();
                        } catch (corsError) {
                            console.warn('ç›´æ¥è®¿é—®å—CORSé™åˆ¶ï¼Œå°è¯•é€šè¿‡ä»£ç†:', corsError.message);
                            // å¦‚æœCORSå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä»£ç†æˆ–æç¤ºç”¨æˆ·
                            throw new Error('æ— æ³•è®¿é—®è¯¥åœ°å€ï¼Œå¯èƒ½å­˜åœ¨è·¨åŸŸé™åˆ¶ã€‚è¯·å°è¯•ï¼š\n1. ä½¿ç”¨æ”¯æŒCORSçš„æ’­æ”¾åˆ—è¡¨åœ°å€\n2. æˆ–ç›´æ¥è¾“å…¥è§†é¢‘æµåœ°å€');
                        }

                        // æ£€æŸ¥æ˜¯å¦ä¸ºM3Uæ ¼å¼
                        if (content.startsWith('#EXTM3U') || content.includes('#EXTINF')) {
                            console.log('æ£€æµ‹åˆ°M3Uæ’­æ”¾åˆ—è¡¨');
                            parseM3UAndShowChannels(content);
                        } else if (content.includes('http') && (content.includes('.m3u8') || content.includes('stream'))) {
                            console.log('æ£€æµ‹åˆ°å¯èƒ½çš„æ’­æ”¾åˆ—è¡¨å†…å®¹');
                            parseM3UAndShowChannels(content);
                        } else {
                            // å¦‚æœä¸æ˜¯M3Uæ ¼å¼ï¼Œå°è¯•ä½œä¸ºç›´æ¥é“¾æ¥æ’­æ”¾
                            console.log('å†…å®¹æ ¼å¼æœªçŸ¥ï¼Œå°è¯•ä½œä¸ºè§†é¢‘é“¾æ¥æ’­æ”¾');
                            playVideoDirectly(url);
                        }
                    } catch (fetchError) {
                        if (fetchError.message.includes('è·¨åŸŸé™åˆ¶')) {
                            throw fetchError;
                        } else {
                            // å¦‚æœè·å–å†…å®¹å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ’­æ”¾
                            console.log('è·å–å†…å®¹å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ’­æ”¾:', fetchError.message);
                            playVideoDirectly(url);
                        }
                    }
                }
            } catch (error) {
                console.error('å¤„ç†åœ°å€å¤±è´¥:', error);
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    urlBtn.classList.remove('loading');
                    urlBtnText.textContent = 'æ’­æ”¾';
                }, 1000);
            }
        }

        function playVideoDirectly(url) {
            try {
                // æ›´æ–°è§†é¢‘æ ‡é¢˜
                videoTitle = 'ç›´é“¾æ’­æ”¾';
                document.title = 'ç›´é“¾æ’­æ”¾ - KatelyaTV';

                // æ›´æ–°è§†é¢‘æ ‡é¢˜æ˜¾ç¤º
                const videoTitleElement = document.querySelector('.video-title h1');
                if (videoTitleElement) {
                    videoTitleElement.textContent = 'ç›´é“¾æ’­æ”¾';
                }

                // æ›´æ–°é¢åŒ…å±‘
                const breadcrumbElement = document.querySelector('.breadcrumb');
                if (breadcrumbElement) {
                    breadcrumbElement.innerHTML = '<a href="#">ç›´é“¾æ’­æ”¾</a>';
                }

                // ä½¿ç”¨æ’­æ”¾å™¨æ’­æ”¾
                if (art) {
                    art.switchUrl(url);
                } else {
                    // å¦‚æœæ’­æ”¾å™¨æœªåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ’­æ”¾å™¨
                    currentVideoUrl = url;
                    initPlayer(url);
                }

                console.log('ç›´é“¾åœ°å€æ’­æ”¾æˆåŠŸ');
            } catch (error) {
                console.error('æ’­æ”¾ç›´é“¾åœ°å€å¤±è´¥:', error);
                alert('æ’­æ”¾å¤±è´¥: ' + error.message);
            }
        }

        function isDirectVideoUrl(url) {
            try {
                const urlObj = new URL(url);
                const pathname = urlObj.pathname.toLowerCase();

                // æ£€æŸ¥æ˜¯å¦ä¸ºæ”¯æŒçš„ç›´æ¥è§†é¢‘æ ¼å¼
                return pathname.endsWith('.m3u8') ||
                    pathname.endsWith('.mp4') ||
                    pathname.endsWith('.flv') ||
                    pathname.endsWith('.avi') ||
                    pathname.endsWith('.mkv') ||
                    pathname.endsWith('.mov') ||
                    pathname.includes('m3u8');
            } catch (e) {
                return false;
            }
        }

        function isValidVideoUrl(url) {
            try {
                const urlObj = new URL(url);
                // åªè¦æ˜¯æœ‰æ•ˆçš„HTTP/HTTPS URLå°±å¯ä»¥å°è¯•å¤„ç†
                return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch (e) {
                return false;
            }
        }

        // è§£æM3Uæ’­æ”¾åˆ—è¡¨
        function parseM3UAndShowChannels(content) {
            channelList = [];
            const lines = content.split('\n');
            let currentChannel = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('#EXTINF:')) {
                    // è§£æé¢‘é“ä¿¡æ¯
                    currentChannel = parseEXTINF(line);
                } else if (line && !line.startsWith('#') && currentChannel) {
                    // è¿™æ˜¯é¢‘é“çš„URL
                    currentChannel.url = line;
                    channelList.push(currentChannel);
                    currentChannel = null;
                }
            }

            console.log(`è§£æåˆ° ${channelList.length} ä¸ªé¢‘é“`);

            // æ›´æ–°ç•Œé¢æ˜¾ç¤ºé¢‘é“åˆ—è¡¨
            showChannelList();
        }

        // è§£æEXTINFè¡Œ
        function parseEXTINF(line) {
            const channel = {
                name: '',
                logo: '',
                group: '',
                url: ''
            };

            // æå–tvg-name
            const nameMatch = line.match(/tvg-name="([^"]*)"/);
            if (nameMatch) {
                channel.tvgName = nameMatch[1];
            }

            // æå–tvg-logo
            const logoMatch = line.match(/tvg-logo="([^"]*)"/);
            if (logoMatch) {
                channel.logo = logoMatch[1];
            }

            // æå–group-title
            const groupMatch = line.match(/group-title="([^"]*)"/);
            if (groupMatch) {
                channel.group = groupMatch[1];
            }

            // æå–é¢‘é“åç§°ï¼ˆé€—å·åé¢çš„éƒ¨åˆ†ï¼‰
            const nameFromEnd = line.split(',').pop();
            if (nameFromEnd) {
                channel.name = nameFromEnd.trim();
            }

            // å¦‚æœæ²¡æœ‰nameï¼Œä½¿ç”¨tvg-name
            if (!channel.name && channel.tvgName) {
                channel.name = channel.tvgName;
            }

            return channel;
        }

        // æ˜¾ç¤ºé¢‘é“åˆ—è¡¨
        function showChannelList() {
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            videoTitle = 'IPTVé¢‘é“åˆ—è¡¨';
            document.title = 'IPTVé¢‘é“åˆ—è¡¨ - KatelyaTV';

            const videoTitleElement = document.querySelector('.video-title h1');
            if (videoTitleElement) {
                videoTitleElement.textContent = 'IPTVé¢‘é“åˆ—è¡¨';
            }

            const breadcrumbElement = document.querySelector('.breadcrumb');
            if (breadcrumbElement) {
                breadcrumbElement.innerHTML = '<a href="#">IPTVé¢‘é“åˆ—è¡¨</a>';
            }

            // åˆ‡æ¢åˆ°é€‰å°æ¨¡å¼
            const episodeSelector = document.querySelector('.episode-selector');
            if (episodeSelector) {
                // éšè—é€‰é›†èŒƒå›´
                const episodeRange = document.querySelector('.episode-range');
                if (episodeRange) {
                    episodeRange.style.display = 'none';
                }

                // æ›´æ–°æ ‡ç­¾
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.textContent === 'é€‰é›†') {
                        tab.textContent = 'é€‰å°';
                        tab.classList.add('active');
                    }
                });

                // æ˜¾ç¤ºé¢‘é“åˆ—è¡¨
                const episodeGrid = document.querySelector('.episode-grid');
                if (episodeGrid) {
                    episodeGrid.classList.add('sources-mode');
                    episodeGrid.innerHTML = renderChannelList();
                }
            }
        }

        // æ¸²æŸ“é¢‘é“åˆ—è¡¨HTML
        function renderChannelList() {
            if (channelList.length === 0) {
                return `
                    <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                        <div style="margin-bottom: 10px;">ğŸ“º æœªæ‰¾åˆ°é¢‘é“</div>
                        <div style="font-size: 14px; opacity: 0.7;">æ’­æ”¾åˆ—è¡¨å¯èƒ½ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®</div>
                    </div>
                `;
            }

            // æŒ‰åˆ†ç»„æ•´ç†é¢‘é“
            const groupedChannels = {};
            channelList.forEach(channel => {
                const group = channel.group || 'å…¶ä»–é¢‘é“';
                if (!groupedChannels[group]) {
                    groupedChannels[group] = [];
                }
                groupedChannels[group].push(channel);
            });

            let html = '';
            Object.keys(groupedChannels).forEach(group => {
                // è·³è¿‡æ›´æ–°æ—¶é—´ç»„
                if (group.includes('æ›´æ–°æ—¶é—´')) {
                    return;
                }

                html += `<div class="channel-group-title">${group} (${groupedChannels[group].length})</div>`;

                groupedChannels[group].forEach((channel, index) => {
                    html += `
                        <div class="channel-item" data-channel-url="${encodeURIComponent(channel.url)}" data-channel-name="${encodeURIComponent(channel.name)}">
                            <div class="channel-info">
                                ${channel.logo ? `<img src="${channel.logo}" class="channel-logo" onerror="this.style.display='none'">` : '<div class="channel-logo-placeholder">ğŸ“º</div>'}
                                <div class="channel-details">
                                    <div class="channel-name">${channel.name}</div>
                                </div>
                            </div>
                            <button class="channel-btn" data-channel-index="${groupedChannels[group].indexOf(channel)}">æ’­æ”¾</button>
                        </div>
                    `;
                });
            });

            // ç»‘å®šé¢‘é“ç‚¹å‡»äº‹ä»¶
            setTimeout(() => bindChannelEvents(), 100);

            return html;
        }

        // ç¼©çŸ­URLæ˜¾ç¤º
        function shortenUrl(url) {
            if (url.length > 50) {
                return url.substring(0, 30) + '...' + url.slice(-20);
            }
            return url;
        }

        // ç»‘å®šé¢‘é“ç‚¹å‡»äº‹ä»¶
        function bindChannelEvents() {
            document.querySelectorAll('.channel-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const channelItem = this.closest('.channel-item');
                    const channelUrl = decodeURIComponent(channelItem.getAttribute('data-channel-url'));
                    const channelName = decodeURIComponent(channelItem.getAttribute('data-channel-name'));

                    playChannel(channelUrl, channelName);
                });
            });

            document.querySelectorAll('.channel-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    if (e.target.classList.contains('channel-btn')) return;

                    const channelUrl = decodeURIComponent(this.getAttribute('data-channel-url'));
                    const channelName = decodeURIComponent(this.getAttribute('data-channel-name'));

                    playChannel(channelUrl, channelName);
                });
            });
        }

        // æ’­æ”¾é¢‘é“
        function playChannel(url, name) {
            console.log('æ’­æ”¾é¢‘é“:', name, url);

            try {
                // æ›´æ–°è§†é¢‘ä¿¡æ¯
                videoTitle = name;
                document.title = `${name} - KatelyaTV`;

                const videoTitleElement = document.querySelector('.video-title h1');
                if (videoTitleElement) {
                    videoTitleElement.textContent = name;
                }

                const breadcrumbElement = document.querySelector('.breadcrumb');
                if (breadcrumbElement) {
                    breadcrumbElement.innerHTML = `<a href="#">IPTV</a> > ${name}`;
                }

                // æ’­æ”¾è§†é¢‘
                if (art) {
                    art.switchUrl(url);
                } else {
                    currentVideoUrl = url;
                    initPlayer(url);
                }

                console.log('é¢‘é“æ’­æ”¾æˆåŠŸ:', name);
            } catch (error) {
                console.error('æ’­æ”¾é¢‘é“å¤±è´¥:', error);
                alert('æ’­æ”¾å¤±è´¥: ' + error.message);
            }
        }

        // ç»‘å®šç½‘å€è¾“å…¥æ¡†äº‹ä»¶
        urlBtn.addEventListener('click', function () {
            const url = urlInput.value;
            playDirectUrl(url);
        });

        // æ”¯æŒå›è½¦é”®æ’­æ”¾
        urlInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const url = urlInput.value;
                playDirectUrl(url);
            }
        });

        // è¾“å…¥æ¡†ç„¦ç‚¹äº‹ä»¶
        urlInput.addEventListener('focus', function () {
            this.select(); // é€‰ä¸­å…¨éƒ¨æ–‡æœ¬
        });

        // è§†é¢‘æ’­æ”¾å™¨ç‚¹å‡»äº‹ä»¶
        document.querySelector('.video-placeholder').addEventListener('click', function () {

        });
    </script>
</body>

</html>